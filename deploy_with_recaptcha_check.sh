#!/bin/bash

# üöÄ –î–µ–ø–ª–æ–π —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π Google reCAPTCHA v3

echo "üöÄ –î–ï–ü–õ–û–ô –ü–†–ê–í–û–°–õ–ê–í–ù–û–ì–û –ü–û–†–¢–ê–õ–ê –° reCAPTCHA"
echo "=============================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "manage.py" ]; then
    echo "‚ùå –§–∞–π–ª manage.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

echo "üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –¥–µ–ø–ª–æ—é
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –¥–µ–ø–ª–æ—é..."
echo "----------------------------------------------"

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
echo "üß™ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ reCAPTCHA –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
python check_production_recaptcha.py

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
if [ $? -ne 0 ]; then
    echo ""
    echo "‚ö†Ô∏è –ü–†–û–í–ï–†–ö–ê –ü–†–û–í–ê–õ–ò–õ–ê–°–¨!"
    echo "========================"
    echo ""
    echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ reCAPTCHA"
    echo "   –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º"
    echo ""
    exit 1
fi

echo ""
echo "‚úÖ –ü–†–û–í–ï–†–ö–ê –ü–†–û–ô–î–ï–ù–ê! –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
echo "========================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã
if [ -n "$(git status --porcelain)" ]; then
    echo ""
    echo "‚ö†Ô∏è –£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
    echo "   –•–æ—Ç–∏—Ç–µ –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏? (y/n)"
    read -p "–í–≤–µ–¥–∏—Ç–µ y –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç–∞ –∏–ª–∏ n –¥–ª—è –æ—Ç–º–µ–Ω—ã: " choice
    
    case "$choice" in 
        y|Y ) 
            echo "üìù –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
            git add .
            git commit -m "üîí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ Google reCAPTCHA v3 –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è:
- –£—Å–ª–æ–≤–Ω–∞—è reCAPTCHA (–æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ DEBUG —Ä–µ–∂–∏–º–µ) 
- –ü—Ä–æ–¥–∞–∫—à–µ–Ω: –ø–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞: —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∫–∞–ø—á–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞ dobrist.com –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
- –ì–æ—Ç–æ–≤–æ –∫ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –±–æ—Ç–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ!"
            ;;
        n|N ) 
            echo "‚ùå –î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é"
            exit 1
            ;;
        * ) 
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥. –î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω"
            exit 1
            ;;
    esac
fi

# –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo ""
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
git push origin main

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
    exit 1
fi

# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä..."
echo "======================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ ./deploy.sh
if [ -f "./deploy.sh" ]; then
    chmod +x ./deploy.sh
    ./deploy.sh
    
    if [ $? -eq 0 ]; then
        echo ""
        echo "üéâ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"
        echo "=========================="
        echo ""
        echo "‚úÖ reCAPTCHA –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ"
        echo "‚úÖ –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –±–æ—Ç–æ–≤"
        echo "‚úÖ –ü–æ—Ä–æ–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: 0.85 (–≤—ã—Å–æ–∫–∏–π)"
        echo ""
        echo "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:"
        echo "   ‚Ä¢ –¢–µ—Å—Ç —Ñ–æ—Ä–º—ã: https://dobrist.com/accounts/signup/"
        echo "   ‚Ä¢ reCAPTCHA Admin: https://www.google.com/recaptcha/admin"
        echo "   ‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: https://dobrist.com/admin/"
        echo ""
        echo "üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:"
        echo "   1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ Google reCAPTCHA Admin"
        echo "   3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫ –∫–∞–ø—á–∏"
        echo "   4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ RECAPTCHA_REQUIRED_SCORE"
        
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
        exit 1
    fi
else
    echo "‚ö†Ô∏è –§–∞–π–ª deploy.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–ø–ª–æ–π –≤—Ä—É—á–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
    echo ""
    echo "   ssh your-server"
    echo "   cd /path/to/pravoslavie_portal"
    echo "   git pull origin main"
    echo "   pip install -r requirements.txt"
    echo "   python manage.py migrate"
    echo "   python manage.py collectstatic --noinput"
    echo "   sudo systemctl restart gunicorn"
    echo "   sudo systemctl restart nginx"
fi

echo ""
echo "üîí reCAPTCHA –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
