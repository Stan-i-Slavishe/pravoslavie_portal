import os
import sys
import django

print("üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è - –ü—Ä–∞–∑–¥–Ω–∏–∫ + –ü–æ—Å—Ç")
print("=" * 55)

try:
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Django
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    django.setup()
    print("‚úÖ Django –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    
    from pwa.models import OrthodoxEvent, DailyOrthodoxInfo, FastingPeriod
    from datetime import date, timedelta
    print("‚úÖ –ú–æ–¥–µ–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
    
    # 1. –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –†–æ–∂–¥–µ—Å—Ç–≤–æ –ò–æ–∞–Ω–Ω–∞ –ü—Ä–µ–¥—Ç–µ—á–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    print("\nüéÇ –ü—Ä–æ–≤–µ—Ä—è–µ–º –†–æ–∂–¥–µ—Å—Ç–≤–æ –ò–æ–∞–Ω–Ω–∞ –ü—Ä–µ–¥—Ç–µ—á–∏ (7 –∏—é–ª—è)...")
    july_7_events = OrthodoxEvent.objects.filter(month=7, day=7, title__icontains="–ò–æ–∞–Ω–Ω")
    
    if not july_7_events.exists():
        print("   üìÖ –î–æ–±–∞–≤–ª—è–µ–º –†–æ–∂–¥–µ—Å—Ç–≤–æ –ò–æ–∞–Ω–Ω–∞ –ü—Ä–µ–¥—Ç–µ—á–∏...")
        event = OrthodoxEvent.objects.create(
            title="–†–æ–∂–¥–µ—Å—Ç–≤–æ —á–µ—Å—Ç–Ω–æ–≥–æ —Å–ª–∞–≤–Ω–æ–≥–æ –ü—Ä–æ—Ä–æ–∫–∞, –ü—Ä–µ–¥—Ç–µ—á–∏ –∏ –ö—Ä–µ—Å—Ç–∏—Ç–µ–ª—è –ì–æ—Å–ø–æ–¥–Ω—è –ò–æ–∞–Ω–Ω–∞",
            description="–í–µ–ª–∏–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫ –≤ —á–µ—Å—Ç—å —Ä–æ–∂–¥–µ–Ω–∏—è —Å–≤. –ò–æ–∞–Ω–Ω–∞ –ü—Ä–µ–¥—Ç–µ—á–∏",
            event_type="great_feast",
            month=7, day=7,
            is_old_style=False, is_movable=False
        )
        print(f"   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: {event.title}")
    else:
        print(f"   ‚úÖ –£–∂–µ –µ—Å—Ç—å: {july_7_events.first().title}")
    
    # 2. –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ü–µ—Ç—Ä–æ–≤ –ø–æ—Å—Ç
    print("\n‚õ™ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ü–µ—Ç—Ä–æ–≤ –ø–æ—Å—Ç...")
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –ü–µ—Ç—Ä–æ–≤–∞ –ø–æ—Å—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
    old_petrov = FastingPeriod.objects.filter(name='peter_paul_fast')
    if old_petrov.exists():
        old_petrov.delete()
        print("   üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –ü–µ—Ç—Ä–æ–≤–∞ –ø–æ—Å—Ç–∞")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ü–µ—Ç—Ä–æ–≤ –ø–æ—Å—Ç
    print("   üìÖ –°–æ–∑–¥–∞–µ–º –ü–µ—Ç—Ä–æ–≤ –ø–æ—Å—Ç...")
    petrov_post = FastingPeriod.objects.create(
        name='peter_paul_fast',
        title='–ü–µ—Ç—Ä–æ–≤ –ø–æ—Å—Ç (–ê–ø–æ—Å—Ç–æ–ª—å—Å–∫–∏–π –ø–æ—Å—Ç)', 
        description='–ê–ø–æ—Å—Ç–æ–ª—å—Å–∫–∏–π –ø–æ—Å—Ç –≤ —á–µ—Å—Ç—å —Å–≤—è—Ç—ã—Ö –∞–ø–æ—Å—Ç–æ–ª–æ–≤ –ü–µ—Ç—Ä–∞ –∏ –ü–∞–≤–ª–∞. –ü–µ—Ä–µ—Ö–æ–¥—è—â–∏–π –ø–æ—Å—Ç –æ—Ç –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –ø–æ—Å–ª–µ –¢—Ä–æ–∏—Ü—ã –¥–æ 12 –∏—é–ª—è.',
        
        # –ü–µ—Ä–µ—Ö–æ–¥—è—â–µ–µ –Ω–∞—á–∞–ª–æ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –ø–æ—Å–ª–µ –¢—Ä–æ–∏—Ü—ã)
        easter_start_offset=57,  # –¢—Ä–æ–∏—Ü–∞ = –ü–∞—Å—Ö–∞ + 49, –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = +1 –¥–µ–Ω—å, –∏—Ç–æ–≥–æ 57
        easter_end_offset=None,  # –ö–æ–Ω–µ—Ü —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
        
        # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω–µ—Ü (11 –∏—é–ª—è, –¥–µ–Ω—å –ø–µ—Ä–µ–¥ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º)
        start_month=None, start_day=None,
        end_month=7, end_day=11,
        
        # –ü—Ä–∞–≤–∏–ª–∞ –ø–æ—Å—Ç–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
        fasting_rules={
            'monday': 'light_fast',     # –ì–æ—Ä—è—á–µ–µ –±–µ–∑ –º–∞—Å–ª–∞
            'tuesday': 'with_oil',      # –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–∞—è –ø–∏—â–∞ —Å –º–∞—Å–ª–æ–º
            'wednesday': 'light_fast',  # –ì–æ—Ä—è—á–µ–µ –±–µ–∑ –º–∞—Å–ª–∞
            'thursday': 'with_oil',     # –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–∞—è –ø–∏—â–∞ —Å –º–∞—Å–ª–æ–º 
            'friday': 'light_fast',     # –ì–æ—Ä—è—á–µ–µ –±–µ–∑ –º–∞—Å–ª–∞
            'saturday': 'with_fish',    # –ú–æ–∂–Ω–æ —Ä—ã–±—É
            'sunday': 'with_fish'       # –ú–æ–∂–Ω–æ —Ä—ã–±—É
        },
        
        priority=8,  # –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        is_active=True
    )
    print(f"   ‚úÖ –°–æ–∑–¥–∞–Ω: {petrov_post.title}")
    print(f"   ‚è∞ –ù–∞—á–∞–ª–æ: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –ø–æ—Å–ª–µ –¢—Ä–æ–∏—Ü—ã (–ø–µ—Ä–µ—Ö–æ–¥—è—â–∏–π)")
    print(f"   ‚è∞ –ö–æ–Ω–µ—Ü: 11 –∏—é–ª—è (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)")
    
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è 7 –∏—é–ª—è 2025
    print(f"\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º 7 –∏—é–ª—è 2025...")
    test_date = date(2025, 7, 7)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ—Å—Ç
    is_petrov_active = petrov_post.is_active_for_date(test_date)
    print(f"   üìÖ –î–∞—Ç–∞: {test_date} (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)")
    print(f"   ‚õ™ –ü–µ—Ç—Ä–æ–≤ –ø–æ—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω: {'‚úÖ –î–ê' if is_petrov_active else '‚ùå –ù–ï–¢'}")
    
    if is_petrov_active:
        weekday = test_date.weekday()  # 0 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        fasting_type = petrov_post.get_fasting_type_for_weekday(weekday)
        print(f"   üçΩÔ∏è –¢–∏–ø –ø–æ—Å—Ç–∞ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫: {fasting_type}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ 7 –∏—é–ª—è
    events_7_july = OrthodoxEvent.get_events_for_date(test_date)
    print(f"   üéâ –°–æ–±—ã—Ç–∏—è: {len(events_7_july)} —à—Ç.")
    for event in events_7_july:
        print(f"      - {event.title} ({event.get_event_type_display()})")
    
    # 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–Ω—è
    print(f"\nüßÆ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º...")
    
    # –ü–æ–ª—É—á–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    daily_info = DailyOrthodoxInfo.get_info_for_date(test_date)
    print(f"   üìñ –¢–∏–ø –ø–æ—Å—Ç–∞ (–µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∏–Ω—Ñ.): {daily_info.fasting_type}")
    print(f"   üìñ –û–ø–∏—Å–∞–Ω–∏–µ: {daily_info.fasting_description}")
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–Ω—è
    is_holiday = any(event.event_type in ['great_feast', 'major_feast'] for event in events_7_july)
    is_fast = is_petrov_active and fasting_type != 'no_fast'
    
    print(f"   üéâ –ï—Å—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫: {'‚úÖ –î–ê' if is_holiday else '‚ùå –ù–ï–¢'}")
    print(f"   ‚õ™ –ï—Å—Ç—å –ø–æ—Å—Ç: {'‚úÖ –î–ê' if is_fast else '‚ùå –ù–ï–¢'}")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–Ω—è
    if is_holiday and is_fast:
        day_type = 'holiday-fast'
        print(f"   üé® –¢–∏–ø –¥–Ω—è: {day_type} (–ü—Ä–∞–∑–¥–Ω–∏–∫ + –ü–æ—Å—Ç)")
        print(f"   üé® –¶–≤–µ—Ç: –†–æ–∑–æ–≤–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π")
    elif is_holiday:
        day_type = 'holiday'
        print(f"   üé® –¢–∏–ø –¥–Ω—è: {day_type} (–¢–æ–ª—å–∫–æ –ø—Ä–∞–∑–¥–Ω–∏–∫)")
        print(f"   üé® –¶–≤–µ—Ç: –ö—Ä–∞—Å–Ω—ã–π")
    elif is_fast:
        day_type = 'fast-day'
        print(f"   üé® –¢–∏–ø –¥–Ω—è: {day_type} (–¢–æ–ª—å–∫–æ –ø–æ—Å—Ç)")
        print(f"   üé® –¶–≤–µ—Ç: –§–∏–æ–ª–µ—Ç–æ–≤—ã–π")
    else:
        day_type = 'feast'
        print(f"   üé® –¢–∏–ø –¥–Ω—è: {day_type} (–û–±—ã—á–Ω—ã–π)")
        print(f"   üé® –¶–≤–µ—Ç: –ë–µ–ª—ã–π")
    
    print(f"\nüéâ –†–ï–ó–£–õ–¨–¢–ê–¢:")
    print(f"7 –∏—é–ª—è 2025 –¥–æ–ª–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫: {day_type}")
    print(f"‚úÖ –†–æ–∂–¥–µ—Å—Ç–≤–æ –ò–æ–∞–Ω–Ω–∞ –ü—Ä–µ–¥—Ç–µ—á–∏ (–≤–µ–ª–∏–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫)")
    print(f"‚úÖ –ü–µ—Ç—Ä–æ–≤ –ø–æ—Å—Ç (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –≥–æ—Ä—è—á–µ–µ –±–µ–∑ –º–∞—Å–ª–∞)")
    print(f"üé® –¶–≤–µ—Ç: –ü—Ä–∞–∑–¥–Ω–∏–∫ + –ü–æ—Å—Ç (—Ä–æ–∑–æ–≤–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π)")
    
    print(f"\nüîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ!")
    
except Exception as e:
    print(f"‚ùå –û–®–ò–ë–ö–ê: {e}")
    import traceback
    traceback.print_exc()

input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
