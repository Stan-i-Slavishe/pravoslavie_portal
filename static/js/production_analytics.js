/* 
 * PRODUCTION ANALYTICS SYSTEM
 * –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫
 * –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–∫—É–ø–∫–∏, –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
 */

class ProductionAnalytics {
    constructor() {
        this.sessionId = this.generateSessionId();
        this.userId = this.getUserId();
        this.debug = window.DEBUG || false;
        this.init();
    }
    
    init() {
        this.trackPageView();
        this.bindEvents();
        this.startSessionTracking();
        if (this.debug) console.log('üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID —Å–µ—Å—Å–∏–∏
    generateSessionId() {
        const stored = sessionStorage.getItem('analytics_session_id');
        if (stored) return stored;
        
        const sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('analytics_session_id', sessionId);
        return sessionId;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    getUserId() {
        const userIdMeta = document.querySelector('meta[name="user-id"]');
        return userIdMeta ? userIdMeta.content : null;
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    trackPageView() {
        this.sendEvent('page_view', {
            page_url: window.location.href,
            page_title: document.title,
            referrer: document.referrer,
            user_agent: navigator.userAgent,
            screen_resolution: `${screen.width}x${screen.height}`,
            timestamp: new Date().toISOString()
        });
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫ (—Ä–µ–∞–ª—å–Ω—ã—Ö, –Ω–µ –∑–∞–≥–ª—É—à–µ–∫!)
    trackPurchase(productId, productType, amount, currency = 'RUB') {
        this.sendEvent('purchase', {
            product_id: productId,
            product_type: productType,
            amount: amount,
            currency: currency,
            payment_method: 'test', // –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ real
            timestamp: new Date().toISOString()
        });
        
        if (this.debug) console.log('üí∞ –û—Ç—Å–ª–µ–∂–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∞:', productId);
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
    trackAddToCart(productId, productType, price) {
        this.sendEvent('add_to_cart', {
            product_id: productId,
            product_type: productType,
            price: price,
            timestamp: new Date().toISOString()
        });
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
    trackDownload(itemId, itemType, format = 'pdf') {
        this.sendEvent('download', {
            item_id: itemId,
            item_type: itemType,
            format: format,
            timestamp: new Date().toISOString()
        });
        
        if (this.debug) console.log('üì• –û—Ç—Å–ª–µ–∂–µ–Ω–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ:', itemId);
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–∞–π–∫–æ–≤ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
    trackInteraction(action, targetId, targetType) {
        this.sendEvent('interaction', {
            action: action, // like, dislike, share, bookmark
            target_id: targetId,
            target_type: targetType,
            timestamp: new Date().toISOString()
        });
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞
    trackSearch(query, resultsCount, category = null) {
        this.sendEvent('search', {
            query: query,
            results_count: resultsCount,
            category: category,
            timestamp: new Date().toISOString()
        });
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    startSessionTracking() {
        this.sessionStartTime = Date.now();
        this.lastActivityTime = Date.now();
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        ['click', 'scroll', 'keypress', 'mousemove'].forEach(event => {
            document.addEventListener(event, () => {
                this.lastActivityTime = Date.now();
            });
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
        window.addEventListener('beforeunload', () => {
            this.trackSessionEnd();
        });
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        setInterval(() => {
            this.trackTimeOnPage();
        }, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    }
    
    trackSessionEnd() {
        const sessionDuration = Date.now() - this.sessionStartTime;
        const activeTime = this.lastActivityTime - this.sessionStartTime;
        
        this.sendEvent('session_end', {
            session_duration: sessionDuration,
            active_time: activeTime,
            pages_viewed: this.pagesViewed || 1,
            timestamp: new Date().toISOString()
        }, true); // –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    }
    
    trackTimeOnPage() {
        const timeOnPage = Date.now() - this.sessionStartTime;
        this.sendEvent('time_on_page', {
            time_seconds: Math.floor(timeOnPage / 1000),
            timestamp: new Date().toISOString()
        });
    }
    
    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
    bindEvents() {
        // –ü–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
        document.addEventListener('click', (e) => {
            // –ö–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏
            if (e.target.matches('[data-product-id]')) {
                const productId = e.target.dataset.productId;
                const productType = e.target.dataset.productType;
                const price = e.target.dataset.price;
                
                if (e.target.textContent.includes('–ö—É–ø–∏—Ç—å') || e.target.textContent.includes('–í –∫–æ—Ä–∑–∏–Ω—É')) {
                    this.trackAddToCart(productId, productType, price);
                }
            }
            
            // –°–∫–∞—á–∏–≤–∞–Ω–∏—è
            if (e.target.matches('[data-download-id]')) {
                const itemId = e.target.dataset.downloadId;
                const itemType = e.target.dataset.downloadType;
                this.trackDownload(itemId, itemType);
            }
            
            // –õ–∞–π–∫–∏ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
            if (e.target.matches('.like-button')) {
                const targetId = e.target.dataset.targetId;
                const targetType = e.target.dataset.targetType;
                this.trackInteraction('like', targetId, targetType);
            }
            
            if (e.target.matches('.share-button')) {
                const targetId = e.target.dataset.targetId;
                const targetType = e.target.dataset.targetType;
                this.trackInteraction('share', targetId, targetType);
            }
        });
        
        // –ü–æ–∏—Å–∫
        const searchForms = document.querySelectorAll('form[role="search"], .search-form');
        searchForms.forEach(form => {
            form.addEventListener('submit', (e) => {
                const query = form.querySelector('input[type="search"], input[name="q"]').value;
                this.trackSearch(query, null);
            });
        });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    sendEvent(eventType, data, sync = false) {
        const payload = {
            event_type: eventType,
            session_id: this.sessionId,
            user_id: this.userId,
            data: data,
            timestamp: new Date().toISOString(),
            csrf_token: this.getCSRFToken()
        };
        
        const url = '/analytics/track-event/';
        
        if (sync) {
            // –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
            navigator.sendBeacon(url, JSON.stringify(payload));
        } else {
            // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify(payload),
                credentials: 'same-origin'
            }).catch(error => {
                if (this.debug) console.error('Analytics error:', error);
            });
        }
        
        if (this.debug) console.log(`üìä –°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${eventType}`, data);
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
    getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
    
    // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–∞—Ö
    static trackPurchaseComplete(orderId, totalAmount, items) {
        if (window.analytics) {
            window.analytics.sendEvent('purchase_complete', {
                order_id: orderId,
                total_amount: totalAmount,
                items: items,
                timestamp: new Date().toISOString()
            });
        }
    }
    
    static trackFormSubmission(formName, formData = {}) {
        if (window.analytics) {
            window.analytics.sendEvent('form_submission', {
                form_name: formName,
                form_data: formData,
                timestamp: new Date().toISOString()
            });
        }
    }
    
    static trackError(errorType, errorMessage, errorPage) {
        if (window.analytics) {
            window.analytics.sendEvent('error', {
                error_type: errorType,
                error_message: errorMessage,
                error_page: errorPage,
                timestamp: new Date().toISOString()
            });
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    window.analytics = new ProductionAnalytics();
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
window.trackPurchase = (productId, productType, amount) => {
    if (window.analytics) window.analytics.trackPurchase(productId, productType, amount);
};

window.trackDownload = (itemId, itemType) => {
    if (window.analytics) window.analytics.trackDownload(itemId, itemType);
};

window.trackSearch = (query, resultsCount) => {
    if (window.analytics) window.analytics.trackSearch(query, resultsCount);
};
