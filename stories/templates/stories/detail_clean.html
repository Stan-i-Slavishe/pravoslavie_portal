{% extends 'base.html' %}
{% load static %}

{% block title %}{{ story.title }} - –ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stories.css' %}">
{% endblock %}

{% block content %}
<div class="stories-page">
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="col-lg-8">
            <!-- –í–∏–¥–µ–æ -->
            <div class="story-video-container">
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                <div class="video-controls">
                    <button class="control-btn" onclick="showIframe()" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ –∑–¥–µ—Å—å">
                        <i class="bi bi-play-circle"></i>
                    </button>
                    <button class="control-btn" onclick="showFallback()" title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ YouTube">
                        <i class="bi bi-youtube"></i>
                    </button>
                </div>
                
                <!-- YouTube iframe -->
                {% if story.youtube_embed_id %}
                <iframe 
                    id="youtube-iframe"
                    class="youtube-iframe"
                    src="https://www.youtube.com/embed/{{ story.youtube_embed_id }}?autoplay=0&rel=0&modestbranding=1"
                    allowfullscreen 
                    loading="lazy"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    title="{{ story.title }}"
                    onload="handleIframeLoad()"
                    onerror="handleIframeError()">
                </iframe>
                {% endif %}
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ -->
                {% if story.youtube_embed_id %}
                <div class="video-info">
                    üé• YouTube ID: {{ story.youtube_embed_id }}
                </div>
                {% endif %}
            </div>
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="story-header">
                <h1 class="mb-3">{{ story.title }}</h1>
                
                <!-- –¢–µ–≥–∏ -->
                {% if story.tags.all %}
                <div class="tag-list mb-3">
                    {% for tag in story.tags.all %}
                    <span class="badge" style="background-color: {{ tag.color|default:'#6c757d' }};">
                        <i class="bi bi-tag me-1"></i>{{ tag.name }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="story-description">
                    <p class="lead">{{ story.description }}</p>
                </div>
                
                <!-- –ú–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        {% if story.category %}
                        <p class="mb-1">
                            <i class="bi bi-folder text-primary me-2"></i>
                            <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> 
                            <a href="{% url 'stories:category' story.category.slug %}" class="text-decoration-none">
                                {{ story.category.name }}
                            </a>
                        </p>
                        {% endif %}
                        <p class="mb-1">
                            <i class="bi bi-calendar text-primary me-2"></i>
                            <strong>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong> {{ story.created_at|date:"d.m.Y" }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1">
                            <i class="bi bi-eye text-primary me-2"></i>
                            <strong>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> {{ story.views_count }}
                        </p>
                        <p class="mb-1">
                            <i class="bi bi-heart text-primary me-2"></i>
                            <strong>–õ–∞–π–∫–∏:</strong> 
                            <span id="total-likes">{{ likes_count }}</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="d-flex flex-wrap align-items-center mb-4">
                <!-- –õ–∞–π–∫ -->
                <button class="btn btn-outline-danger me-3 like-button {% if user_liked %}liked{% endif %}" 
                        onclick="likeStory({{ story.id }})" id="main-like-btn">
                    <i class="bi bi-heart{% if user_liked %}-fill{% endif %} me-2"></i>
                    {% if user_liked %}–£–±—Ä–∞—Ç—å –ª–∞–π–∫{% else %}–ù—Ä–∞–≤–∏—Ç—Å—è{% endif %}
                    (<span id="main-likes-count">{{ likes_count }}</span>)
                </button>
                
                <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
                <button class="btn btn-outline-warning me-3" onclick="favoriteStory({{ story.id }})">
                    <i class="bi bi-bookmark me-2"></i>–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                </button>
                
                <!-- –ü–æ–¥–µ–ª–∏—Ç—å—Å—è -->
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown">
                        <i class="bi bi-share me-2"></i>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="https://t.me/share/url?url={{ request.build_absolute_uri }}&text={{ story.title }}" target="_blank">
                                <i class="bi bi-telegram text-primary me-2"></i>Telegram
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="https://vk.com/share.php?url={{ request.build_absolute_uri }}&title={{ story.title }}" target="_blank">
                                <svg class="me-2" width="16" height="16" viewBox="0 0 24 24" fill="#0077FF">
                                    <path d="M12.785 16.241s.288-.032.436-.193c.136-.148.131-.425.131-.425s-.019-1.3.57-1.493c.582-.19 1.329.963 2.121 1.389.6.324 1.056.253 1.056.253l2.123-.03s1.111-.07.584-.967c-.043-.073-.307-.665-1.588-1.879-1.34-1.271-1.161-1.065.454-3.265.984-1.341 1.378-2.158 1.254-2.511-.118-.337-.848-.248-.848-.248l-2.388.015s-.177-.024-.308.056c-.128.078-.21.26-.21.26s-.378 1.032-.881 1.911c-1.059 1.853-1.483 1.952-1.656 1.836-.403-.269-.302-.985-.302-1.519 0-1.65.244-2.337-.475-2.515-.239-.059-.414-.098-1.023-.104-.781-.008-1.441.003-1.815.191-.248.125-.44.403-.324.419.144.02.47.09.642.332.223.313.215.996.215.996s.128 1.973-.299 2.217c-.293.167-.695-.174-1.557-1.834-.442-.854-.775-1.799-.775-1.799s-.064-.175-.179-.268c-.139-.113-.333-.149-.333-.149l-2.267.015s-.341.01-.466.162c-.111.135-.009.413-.009.413s1.778 4.269 3.787 6.418c1.845 1.969 3.935 1.839 3.935 1.839z"/>
                                </svg>–í–ö–æ–Ω—Ç–∞–∫—Ç–µ
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="https://wa.me/?text={{ story.title }} {{ request.build_absolute_uri }}" target="_blank">
                                <i class="bi bi-whatsapp text-success me-2"></i>WhatsApp
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="copyToClipboard('{{ request.build_absolute_uri }}')">
                                <i class="bi bi-copy text-muted me-2"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <div class="col-lg-4">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">
                        <i class="bi bi-graph-up text-primary me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <span class="fs-4 fw-bold text-primary">{{ story.views_count }}</span>
                                <div class="small text-muted">–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <span class="fs-4 fw-bold text-success">{{ likes_count }}</span>
                                <div class="small text-muted">–ª–∞–π–∫–æ–≤</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ {{ story.created_at|date:"d.m.Y" }}
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- –ü–æ—Ö–æ–∂–∏–µ —Ä–∞—Å—Å–∫–∞–∑—ã -->
            {% if related_stories %}
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="mb-3">
                        <i class="bi bi-collection text-primary me-2"></i>–ü–æ—Ö–æ–∂–∏–µ —Ä–∞—Å—Å–∫–∞–∑—ã
                    </h5>
                    {% for related in related_stories %}
                    <div class="border rounded p-2 mb-2">
                        <h6 class="mb-1">
                            <a href="{% url 'stories:detail' related.slug %}" class="text-decoration-none">
                                {{ related.title }}
                            </a>
                        </h6>
                        <small class="text-muted">
                            <i class="bi bi-eye me-1"></i>{{ related.views_count }} ‚Ä¢ {{ related.created_at|date:"d.m.Y" }}
                        </small>
                    </div>
                    {% endfor %}
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'stories:list' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-arrow-left me-2"></i>–í—Å–µ —Ä–∞—Å—Å–∫–∞–∑—ã
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('Professional Stories player loaded');

function showIframe() {
    document.getElementById('youtube-iframe').style.display = 'block';
    console.log('Showing iframe');
}

function showFallback() {
    window.open('{{ story.youtube_url }}', '_blank');
    console.log('Opening YouTube');
}

function handleIframeLoad() {
    console.log('YouTube iframe loaded successfully');
}

function handleIframeError() {
    console.log('YouTube iframe failed to load');
}

// –§—É–Ω–∫—Ü–∏—è –ª–∞–π–∫–∞
function likeStory(storyId) {
    {% if user.is_authenticated %}
    fetch(`/stories/ajax/${storyId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const btn = document.getElementById('main-like-btn');
            const count = document.getElementById('main-likes-count');
            const totalLikes = document.getElementById('total-likes');
            
            if (data.liked) {
                btn.innerHTML = `<i class="bi bi-heart-fill me-2"></i>–£–±—Ä–∞—Ç—å –ª–∞–π–∫ (<span id="main-likes-count">${data.likes_count}</span>)`;
                btn.classList.add('liked');
            } else {
                btn.innerHTML = `<i class="bi bi-heart me-2"></i>–ù—Ä–∞–≤–∏—Ç—Å—è (<span id="main-likes-count">${data.likes_count}</span>)`;
                btn.classList.remove('liked');
            }
            
            totalLikes.textContent = data.likes_count;
        }
    })
    .catch(error => console.error('Error:', error));
    {% else %}
    window.location.href = '/accounts/login/?next={{ request.get_full_path }}';
    {% endif %}
}

function favoriteStory(storyId) {
    {% if user.is_authenticated %}
    fetch(`/stories/ajax/${storyId}/favorite/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
    {% else %}
    window.location.href = '/accounts/login/?next={{ request.get_full_path }}';
    {% endif %}
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    });
}
</script>
{% endblock %}
