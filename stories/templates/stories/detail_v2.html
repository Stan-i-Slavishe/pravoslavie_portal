{% extends 'base.html' %}
{% load static %}

{% block title %}{{ story.title }} - –ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª{% endblock %}

{% block extra_css %}
<style>
    /* üí¨ –°–¢–ò–õ–ò –î–õ–Ø –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í –í –°–¢–ò–õ–ï YOUTUBE */
    .comments-section {
        background: #fff;
        border: none;
        border-radius: 0;
        padding: 24px 0;
    }
    
    .comments-header {
        display: flex;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 0;
    }
    
    .comments-count {
        font-size: 20px;
        font-weight: 400;
        color: #0f0f0f;
        margin-right: 32px;
    }
    
    .sort-comments {
        display: flex;
        align-items: center;
        color: #606060;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        padding: 8px 0;
    }
    
    .sort-comments:hover {
        color: #0f0f0f;
    }
    
    .sort-comments i {
        margin-left: 4px;
        font-size: 16px;
    }
    
    /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è */
    .add-comment-form {
        display: flex;
        margin-bottom: 24px;
        align-items: flex-start;
    }
    
    .comment-avatar-wrapper {
        margin-right: 16px;
        flex-shrink: 0;
    }
    
    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2B5AA0, #D4AF37);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 500;
        font-size: 16px;
        cursor: pointer;
    }
    
    .comment-input-container {
        flex: 1;
        position: relative;
    }
    
    .comment-input {
        width: 100%;
        border: none;
        border-bottom: 1px solid #ccc;
        padding: 8px 0;
        font-size: 14px;
        background: transparent;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
        font-family: 'Roboto', Arial, sans-serif;
    }
    
    .comment-input:focus {
        border-bottom: 2px solid #065fd4;
    }
    
    .comment-input::placeholder {
        color: #606060;
    }
    
    .comment-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .comment-input:focus + .comment-actions,
    .comment-actions.show {
        opacity: 1;
    }
    
    .comment-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 18px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .comment-btn-cancel {
        background: transparent;
        color: #606060;
    }
    
    .comment-btn-cancel:hover {
        background: #f2f2f2;
        color: #0f0f0f;
    }
    
    .comment-btn-submit {
        background: #065fd4;
        color: white;
    }
    
    .comment-btn-submit:hover {
        background: #0553c2;
    }
    
    .comment-btn-submit:disabled {
        background: #f2f2f2;
        color: #909090;
        cursor: not-allowed;
    }
    
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .story-video-container {
        position: relative;
        background: #000;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        margin-bottom: 30px;
        min-height: 500px;
    }
    
    .youtube-iframe {
        width: 100%;
        height: 500px;
        border: none;
        display: block;
        border-radius: 15px;
    }
    
    .story-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }
    
    /* –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ */
    .comments-list {
        margin-top: 0;
    }
    
    .comment-item {
        display: flex;
        margin-bottom: 16px;
        align-items: flex-start;
    }
    
    .comment-item:last-child {
        margin-bottom: 0;
    }
    
    .comment-content {
        flex: 1;
        margin-left: 16px;
    }
    
    .comment-header {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
    }
    
    .comment-author {
        font-size: 13px;
        font-weight: 500;
        color: #0f0f0f;
        margin-right: 8px;
        text-decoration: none;
    }
    
    .comment-author:hover {
        color: #0f0f0f;
    }
    
    .comment-date {
        font-size: 12px;
        color: #606060;
    }
    
    .comment-text {
        font-size: 14px;
        color: #0f0f0f;
        line-height: 20px;
        margin: 2px 0 8px 0;
        word-wrap: break-word;
    }
    
    .comment-actions-bar {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .comment-action-btn {
        display: flex;
        align-items: center;
        padding: 8px;
        background: transparent;
        border: none;
        border-radius: 50%;
        color: #606060;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 16px;
    }
    
    .comment-action-btn:hover {
        background: #f2f2f2;
        color: #0f0f0f;
    }
    
    .comment-action-btn.liked {
        color: #065fd4;
    }
    
    .comment-like-count {
        font-size: 12px;
        color: #606060;
        margin-left: 8px;
        min-width: 16px;
    }
    
    .comment-reply-btn {
        color: #606060;
        background: transparent;
        border: none;
        font-size: 12px;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 18px;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
    }
    
    .comment-reply-btn:hover {
        background: #f2f2f2;
        color: #0f0f0f;
    }
    
    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .no-comments {
        text-align: center;
        padding: 40px 0;
        color: #606060;
    }
    
    .no-comments i {
        font-size: 48px;
        margin-bottom: 16px;
        color: #e0e0e0;
    }
    
    .no-comments h3 {
        font-size: 16px;
        font-weight: 400;
        margin-bottom: 8px;
        color: #0f0f0f;
    }
    
    .no-comments p {
        font-size: 14px;
        color: #606060;
        margin: 0;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .youtube-iframe {
            height: 300px;
        }
        
        .story-video-container {
            min-height: 300px;
        }
        
        .comments-section {
            padding: 16px 0;
        }
        
        .comments-header {
            margin-bottom: 24px;
        }
        
        .comment-avatar {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }
        
        .comment-content {
            margin-left: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="col-lg-8">
            <!-- –í–∏–¥–µ–æ -->
            <div class="story-video-container">
                {% if story.youtube_embed_id %}
                    <iframe 
                        class="youtube-iframe" 
                        src="https://www.youtube.com/embed/{{ story.youtube_embed_id }}"
                        frameborder="0" 
                        allowfullscreen>
                    </iframe>
                {% else %}
                    <div class="no-video d-flex align-items-center justify-content-center text-white">
                        <p>–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="story-header">
                <h1>{{ story.title }}</h1>
                <p class="lead">{{ story.description|linebreaksbr }}</p>
                
                {% if story.tags.exists %}
                    <div class="tag-list">
                        {% for tag in story.tags.all %}
                            <span class="badge bg-secondary me-2">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- üî• –ù–û–í–´–ô –®–ê–ë–õ–û–ù –° –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø–ú–ò! -->
            <h1 style="color: red; background: yellow; padding: 20px; text-align: center;">
                üöÄ –¢–ï–°–¢ - –ù–û–í–´–ô –®–ê–ë–õ–û–ù –ó–ê–ì–†–£–ñ–ï–ù! üöÄ
            </h1>
            <!-- üí¨ –°–ò–°–¢–ï–ú–ê –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í –í –°–¢–ò–õ–ï YOUTUBE -->
            <div class="comments-section" id="comments-section">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                <div class="comments-header">
                    <div class="comments-count">
                        <span id="comments-count">{{ comments_count|default:0 }}</span> –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                    </div>
                    <div class="sort-comments" onclick="toggleSortComments()">
                        <span>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                {% if user.is_authenticated %}
                <div class="add-comment-form">
                    <div class="comment-avatar-wrapper">
                        <div class="comment-avatar" title="{{ user.get_full_name|default:user.username }}">
                            {{ user.first_name.0|default:user.username.0|upper }}
                        </div>
                    </div>
                    <div class="comment-input-container">
                        <form id="add-comment-form" onsubmit="addComment(event)">
                            {% csrf_token %}
                            <textarea 
                                class="comment-input" 
                                id="comment-text"
                                placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." 
                                rows="1"
                                maxlength="1000"
                                onfocus="showCommentActions()"
                                oninput="updateCommentSubmitButton()"
                            ></textarea>
                            <div class="comment-actions" id="comment-actions">
                                <button type="button" class="comment-btn comment-btn-cancel" onclick="cancelComment()">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button type="submit" class="comment-btn comment-btn-submit" id="submit-comment-btn" disabled>
                                    –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ -->
                            <input type="hidden" id="parent-comment-id" name="parent" value="">
                        </form>
                    </div>
                </div>
                {% else %}
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <div class="login-prompt" style="padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px; margin-bottom: 24px;">
                    <p style="margin: 0; color: #606060;">
                        <a href="{% url 'account_login' %}" style="color: #065fd4; text-decoration: none;">–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>, 
                        —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                    </p>
                </div>
                {% endif %}

                <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                <div class="comments-list" id="comments-list">
                    <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                    <div id="comments-loader" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</span>
                        </div>
                    </div>
                    
                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ" -->
                <div id="load-more-container" class="text-center mt-4" style="display: none;">
                    <button id="load-more-btn" class="btn btn-outline-primary btn-sm" onclick="loadMoreComments()">
                        –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-lg-4">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                    <p><strong>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> {{ story.views_count }}</p>
                    <p><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> {{ story.created_at|date:"d.m.Y" }}</p>
                    {% if story.category %}
                        <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ story.category.name }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- –ü–æ—Ö–æ–∂–∏–µ —Ä–∞—Å—Å–∫–∞–∑—ã -->
            {% if related_stories %}
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–ü–æ—Ö–æ–∂–∏–µ —Ä–∞—Å—Å–∫–∞–∑—ã</h5>
                    {% for related in related_stories %}
                        <div class="mb-3">
                            <a href="{{ related.get_absolute_url }}" class="text-decoration-none">
                                <h6>{{ related.title }}</h6>
                            </a>
                            <small class="text-muted">{{ related.description|truncatewords:10 }}</small>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentPage = 1;
let totalPages = 1;
let sortOrder = 'newest';
let storySlug = '{{ story.slug }}';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadComments(1);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
    const commentInput = document.getElementById('comment-text');
    if (commentInput) {
        commentInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function showCommentActions() {
    const actions = document.getElementById('comment-actions');
    if (actions) {
        actions.classList.add('show');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
function updateCommentSubmitButton() {
    const input = document.getElementById('comment-text');
    const btn = document.getElementById('submit-comment-btn');
    if (input && btn) {
        btn.disabled = input.value.trim().length === 0;
    }
}

// –û—Ç–º–µ–Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function cancelComment() {
    const input = document.getElementById('comment-text');
    const actions = document.getElementById('comment-actions');
    const parentId = document.getElementById('parent-comment-id');
    
    if (input) {
        input.value = '';
        input.style.height = 'auto';
        input.blur();
        input.placeholder = '–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...';
    }
    
    if (actions) {
        actions.classList.remove('show');
    }
    
    if (parentId) {
        parentId.value = '';
    }
    
    updateCommentSubmitButton();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
async function loadComments(page = 1, append = false) {
    try {
        const url = `/stories/ajax/${storySlug}/comments/?page=${page}&sort=${sortOrder}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const commentsList = document.getElementById('comments-list');
            const loader = document.getElementById('comments-loader');
            
            if (loader) loader.style.display = 'none';
            
            if (append) {
                commentsList.insertAdjacentHTML('beforeend', data.html);
            } else {
                commentsList.innerHTML = data.html;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            currentPage = data.current_page;
            totalPages = data.total_pages;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"
            const loadMoreContainer = document.getElementById('load-more-container');
            if (loadMoreContainer) {
                loadMoreContainer.style.display = data.has_next ? 'block' : 'none';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            const commentsCount = document.getElementById('comments-count');
            if (commentsCount) {
                commentsCount.textContent = data.total_comments || 0;
            }
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', data.error);
            showCommentError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
        showCommentError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤');
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–æ–ª—å—à–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function loadMoreComments() {
    if (currentPage < totalPages) {
        loadComments(currentPage + 1, true);
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function toggleSortComments() {
    sortOrder = sortOrder === 'newest' ? 'oldest' : 'newest';
    const sortBtn = document.querySelector('.sort-comments span');
    if (sortBtn) {
        sortBtn.textContent = sortOrder === 'newest' ? '–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ' : '–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ';
    }
    loadComments(1, false);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
async function addComment(event) {
    event.preventDefault();
    
    const form = event.target;
    const textInput = document.getElementById('comment-text');
    const submitBtn = document.getElementById('submit-comment-btn');
    const parentId = document.getElementById('parent-comment-id');
    
    const text = textInput.value.trim();
    if (!text) {
        showCommentError('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return;
    }
    
    if (text.length > 1000) {
        showCommentError('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤)');
        return;
    }
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>–û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    try {
        const url = `/stories/ajax/${storySlug}/comments/add/`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                text: text,
                parent_id: parentId.value || null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            textInput.value = '';
            textInput.style.height = 'auto';
            parentId.value = '';
            cancelComment();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            showCommentSuccess(data.message || '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            loadComments(1, false);
        } else {
            showCommentError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
        showCommentError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        submitBtn.disabled = false;
        submitBtn.innerHTML = '–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å';
        updateCommentSubmitButton();
    }
}

// –û—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
function replyToComment(commentId, authorName) {
    const parentIdField = document.getElementById('parent-comment-id');
    const commentInput = document.getElementById('comment-text');
    
    if (parentIdField) {
        parentIdField.value = commentId;
    }
    
    if (commentInput) {
        commentInput.placeholder = `–û—Ç–≤–µ—Ç –¥–ª—è ${authorName}...`;
        commentInput.focus();
        showCommentActions();
    }
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    const commentForm = document.querySelector('.add-comment-form');
    if (commentForm) {
        commentForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// –õ–∞–π–∫/–¥–∏–∑–ª–∞–π–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
async function toggleCommentReaction(commentId, reactionType) {
    try {
        const url = `/stories/ajax/comments/${commentId}/reaction/`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                reaction_type: reactionType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–∞–∫—Ü–∏–π
            const likeBtn = document.querySelector(`[data-comment-id="${commentId}"][data-reaction="like"]`);
            const dislikeBtn = document.querySelector(`[data-comment-id="${commentId}"][data-reaction="dislike"]`);
            const likeCount = document.querySelector(`[data-comment-id="${commentId}"].comment-like-count`);
            
            if (likeBtn && dislikeBtn) {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
                likeBtn.classList.remove('liked');
                dislikeBtn.classList.remove('liked');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏—è
                if (data.user_reaction === 'like') {
                    likeBtn.classList.add('liked');
                } else if (data.user_reaction === 'dislike') {
                    dislikeBtn.classList.add('liked');
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤
            if (likeCount) {
                likeCount.textContent = data.likes_count > 0 ? data.likes_count : '';
            }
        } else {
            showCommentError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∞–∫—Ü–∏–∏');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:', error);
        showCommentError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∞–∫—Ü–∏–∏');
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤
function toggleReplies(commentId) {
    const repliesContainer = document.getElementById(`replies-${commentId}`);
    const toggleBtn = document.querySelector(`[onclick="toggleReplies(${commentId})"]`);
    
    if (repliesContainer && toggleBtn) {
        if (repliesContainer.style.display === 'none') {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç—ã
            loadReplies(commentId);
            repliesContainer.style.display = 'block';
            toggleBtn.classList.add('expanded');
        } else {
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç—ã
            repliesContainer.style.display = 'none';
            toggleBtn.classList.remove('expanded');
        }
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
async function loadReplies(commentId) {
    try {
        const url = `/stories/ajax/comments/${commentId}/replies/`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const repliesContainer = document.getElementById(`replies-${commentId}`);
            if (repliesContainer) {
                repliesContainer.innerHTML = data.html;
            }
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤:', data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç–≤–µ—Ç–æ–≤:', error);
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
function showCommentError(message) {
    showNotification(message, 'danger');
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
function showCommentSuccess(message) {
    showNotification(message, 'success');
}

// –§—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.style.minWidth = '300px';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 4000);
}
</script>
{% endblock %}