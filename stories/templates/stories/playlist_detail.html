{% extends 'base.html' %}
{% load static %}

{% block title %}{{ playlist.name }}{% endblock %}

{% block extra_css %}
<style>
.playlist-header {
    background: linear-gradient(135deg, var(--orthodox-blue, #2B5AA0) 0%, #1e3f73 100%);
    color: white;
    padding: 40px 0;
    margin-bottom: 30px;
}

.playlist-info {
    display: flex;
    align-items: center;
    gap: 20px;
}

.playlist-icon {
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.2);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
}

.playlist-details h1 {
    margin: 0 0 10px 0;
    font-size: 2rem;
    font-weight: 700;
}

.playlist-meta {
    display: flex;
    gap: 20px;
    font-size: 0.9rem;
    opacity: 0.9;
}

.playlist-description {
    margin-top: 15px;
    line-height: 1.6;
    opacity: 0.95;
}

.playlist-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-action {
    padding: 8px 16px;
    border: 2px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.1);
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.btn-action:hover {
    background: rgba(255,255,255,0.2);
    color: white;
    border-color: rgba(255,255,255,0.5);
}

.story-item {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
}

.story-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.story-content {
    display: flex;
    gap: 20px;
    align-items: center;
}

.story-thumbnail {
    width: 120px;
    height: 90px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 2rem;
    flex-shrink: 0;
}

.story-info {
    flex: 1;
}

.story-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--orthodox-blue, #2B5AA0);
    margin-bottom: 8px;
}

.story-title a {
    text-decoration: none;
    color: inherit;
}

.story-title a:hover {
    text-decoration: underline;
}

.story-description {
    color: #666;
    line-height: 1.5;
    margin-bottom: 10px;
}

.story-meta {
    display: flex;
    gap: 15px;
    font-size: 0.85rem;
    color: #888;
}

.story-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-end;
}

.story-order {
    background: var(--gold-accent, #D4AF37);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.btn-remove {
    background: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-remove:hover {
    background: #c82333;
}

.empty-playlist {
    text-align: center;
    padding: 60px 20px;
    color: #666;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.empty-playlist i {
    font-size: 4rem;
    color: #ccc;
    margin-bottom: 20px;
}

.playlist-controls {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.sortable-item {
    cursor: move;
}

.sortable-item:hover {
    background: #f8f9fa;
}

.drag-handle {
    color: #ccc;
    margin-right: 15px;
    cursor: grab;
}

.drag-handle:active {
    cursor: grabbing;
}

@media (max-width: 768px) {
    .playlist-info {
        flex-direction: column;
        text-align: center;
    }
    
    .story-content {
        flex-direction: column;
        text-align: center;
    }
    
    .story-thumbnail {
        align-self: center;
    }
    
    .story-actions {
        flex-direction: row;
        justify-content: center;
        width: 100%;
    }
    
    .playlist-actions {
        flex-wrap: wrap;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="playlist-header">
    <div class="container">
        <div class="playlist-info">
            <div class="playlist-icon">
                <i class="fas fa-list"></i>
            </div>
            <div class="playlist-details">
                <h1>{{ playlist.name }}</h1>
                <div class="playlist-meta">
                    <span>
                        <i class="fas fa-video me-1"></i>
                        {{ playlist_items.count }} рассказ{{ playlist_items.count|pluralize:"ов" }}
                    </span>
                    <span>
                        <i class="fas {% if playlist.is_public %}fa-globe{% else %}fa-lock{% endif %} me-1"></i>
                        {% if playlist.is_public %}Публичный{% else %}Приватный{% endif %}
                    </span>
                    <span>
                        <i class="fas fa-calendar me-1"></i>
                        {{ playlist.created_at|date:"d.m.Y" }}
                    </span>
                </div>
                {% if playlist.description %}
                    <div class="playlist-description">
                        {{ playlist.description }}
                    </div>
                {% endif %}
                <div class="playlist-actions">
                    <a href="{% url 'stories:edit_playlist' playlist.slug %}" class="btn-action">
                        <i class="fas fa-edit me-1"></i>
                        Редактировать
                    </a>
                    <a href="{% url 'stories:playlists_list' %}" class="btn-action">
                        <i class="fas fa-arrow-left me-1"></i>
                        К плейлистам
                    </a>
                    {% if playlist.is_public %}
                        <a href="{% url 'stories:public_playlist_detail' playlist.user.id playlist.slug %}" class="btn-action">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Публичная ссылка
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-12">
            {% if playlist_items %}
                <div class="playlist-controls">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>
                            Рассказы в плейлисте
                        </h3>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="enableSorting()">
                                <i class="fas fa-sort me-1"></i>
                                Изменить порядок
                            </button>
                            <button class="btn btn-sm btn-success d-none" id="saveSortBtn" onclick="saveSorting()">
                                <i class="fas fa-save me-1"></i>
                                Сохранить
                            </button>
                            <button class="btn btn-sm btn-secondary d-none" id="cancelSortBtn" onclick="cancelSorting()">
                                Отмена
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="playlist-items">
                    {% for item in playlist_items %}
                        <div class="story-item" data-story-id="{{ item.story.id }}" data-order="{{ item.order }}">
                            <div class="story-content">
                                <div class="drag-handle d-none">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>
                                <div class="story-thumbnail">
                                    <i class="fas fa-video"></i>
                                </div>
                                <div class="story-info">
                                    <div class="story-title">
                                        <a href="{% url 'stories:detail' item.story.slug %}">
                                            {{ item.story.title }}
                                        </a>
                                    </div>
                                    {% if item.story.description %}
                                        <div class="story-description">
                                            {{ item.story.description|truncatewords:25 }}
                                        </div>
                                    {% endif %}
                                    <div class="story-meta">
                                        {% if item.story.category %}
                                            <span>
                                                <i class="fas fa-folder me-1"></i>
                                                {{ item.story.category.name }}
                                            </span>
                                        {% endif %}
                                        <span>
                                            <i class="fas fa-eye me-1"></i>
                                            {{ item.story.views_count }} просмотр{{ item.story.views_count|pluralize:"ов" }}
                                        </span>
                                        <span>
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ item.story.created_at|date:"d.m.Y" }}
                                        </span>
                                    </div>
                                </div>
                                <div class="story-actions">
                                    <div class="story-order">{{ item.order }}</div>
                                    <button class="btn-remove" onclick="removeFromPlaylist({{ item.story.id }})">
                                        <i class="fas fa-times me-1"></i>
                                        Удалить
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
            {% else %}
                <div class="empty-playlist">
                    <i class="fas fa-video"></i>
                    <h3>Плейлист пуст</h3>
                    <p>Добавьте рассказы в этот плейлист, чтобы создать свою коллекцию</p>
                    <a href="{% url 'stories:list' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Найти рассказы
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
let sortable = null;
let originalOrder = [];

document.addEventListener('DOMContentLoaded', function() {
    // Анимация появления элементов
    const items = document.querySelectorAll('.story-item');
    items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

function enableSorting() {
    // Сохраняем оригинальный порядок
    originalOrder = Array.from(document.querySelectorAll('.story-item')).map(item => ({
        id: item.dataset.storyId,
        order: item.dataset.order
    }));
    
    // Показываем элементы управления сортировкой
    document.querySelectorAll('.drag-handle').forEach(handle => {
        handle.classList.remove('d-none');
    });
    
    document.getElementById('saveSortBtn').classList.remove('d-none');
    document.getElementById('cancelSortBtn').classList.remove('d-none');
    
    // Включаем сортировку
    const container = document.getElementById('playlist-items');
    sortable = Sortable.create(container, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag'
    });
}

function saveSorting() {
    const items = document.querySelectorAll('.story-item');
    const storyOrders = Array.from(items).map((item, index) => ({
        story_id: parseInt(item.dataset.storyId),
        order: index + 1
    }));
    
    // Отправляем AJAX запрос для сохранения порядка
    fetch(`{% url 'stories:reorder_playlist' playlist.slug %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            story_orders: storyOrders
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Обновляем номера в интерфейсе
            items.forEach((item, index) => {
                const orderElement = item.querySelector('.story-order');
                orderElement.textContent = index + 1;
                item.dataset.order = index + 1;
            });
            
            cancelSorting();
            showMessage('Порядок рассказов сохранен', 'success');
        } else {
            showMessage('Ошибка при сохранении порядка', 'error');
        }
    })
    .catch(error => {
        showMessage('Произошла ошибка', 'error');
        console.error('Error:', error);
    });
}

function cancelSorting() {
    // Скрываем элементы управления сортировкой
    document.querySelectorAll('.drag-handle').forEach(handle => {
        handle.classList.add('d-none');
    });
    
    document.getElementById('saveSortBtn').classList.add('d-none');
    document.getElementById('cancelSortBtn').classList.add('d-none');
    
    // Отключаем сортировку
    if (sortable) {
        sortable.destroy();
        sortable = null;
    }
}

function removeFromPlaylist(storyId) {
    if (!confirm('Вы уверены, что хотите удалить этот рассказ из плейлиста?')) {
        return;
    }
    
    fetch(`{% url 'stories:remove_from_playlist' %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            story_id: storyId,
            playlist_id: {{ playlist.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Удаляем элемент из DOM с анимацией
            const storyItem = document.querySelector(`[data-story-id="${storyId}"]`);
            storyItem.style.transition = 'all 0.3s ease';
            storyItem.style.transform = 'translateX(-100%)';
            storyItem.style.opacity = '0';
            
            setTimeout(() => {
                storyItem.remove();
                
                // Обновляем номера оставшихся элементов
                const remainingItems = document.querySelectorAll('.story-item');
                remainingItems.forEach((item, index) => {
                    const orderElement = item.querySelector('.story-order');
                    orderElement.textContent = index + 1;
                    item.dataset.order = index + 1;
                });
                
                // Если плейлист стал пустым, показываем соответствующее сообщение
                if (remainingItems.length === 0) {
                    location.reload();
                }
            }, 300);
            
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Произошла ошибка при удалении', 'error');
        console.error('Error:', error);
    });
}

function showMessage(message, type) {
    // Создаем уведомление
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alert.style.position = 'fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.style.minWidth = '300px';
    
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
