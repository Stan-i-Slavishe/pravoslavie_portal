{% extends 'base.html' %}
{% load static %}

{% block title %}{{ playlist.title }}{% endblock %}

{% block extra_css %}
<!-- Стили плейлистов теперь в static/css/azbyka-style.css -->
{% endblock %}
        font-size: 1.5rem;
        margin-bottom: 15px;
    }
    
    /* КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ для мобильных метаданных */
    .playlist-meta {
        flex-direction: column;
        gap: 8px;
        align-items: center;
        width: 100%;
    }
    
    .playlist-meta span {
        justify-content: center;
        font-size: 0.85rem;
        min-width: auto;
        text-align: center;
    }
    
    .playlist-actions {
        flex-direction: column;
        gap: 8px;
        width: 100%;
        max-width: 250px;
        margin: 15px auto 0;
    }
    
    .btn-action {
        text-align: center;
        padding: 10px 16px;
    }
    
    .story-content {
        flex-direction: column;
        text-align: center;
    }
    
    .story-thumbnail {
        align-self: center;
    }
    
    .story-actions {
        flex-direction: row;
        justify-content: center;
        width: 100%;
    }
}

/* Дополнительные исправления для очень маленьких экранов */
@media (max-width: 480px) {
    .playlist-header {
        padding: 15px 0;
    }
    
    .playlist-details h1 {
        font-size: 1.3rem;
    }
    
    .playlist-meta span {
        font-size: 0.8rem;
    }
    
    .playlist-meta span i {
        margin-right: 6px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="playlist-header">
    <div class="container">
        <div class="playlist-info">
            <div class="playlist-icon">
                <i class="fas fa-list"></i>
            </div>
            <div class="playlist-details">
                <h1>{{ playlist.title }}</h1>
                <div class="playlist-meta">
                    <span>
                        <i class="fas fa-video me-1"></i>
                        {{ playlist_items.count }} рассказ{{ playlist_items.count|pluralize:"ов" }}
                    </span>
                    <span>
                        <i class="fas {% if playlist.is_public %}fa-globe{% else %}fa-lock{% endif %} me-1"></i>
                        {% if playlist.is_public %}Публичный{% else %}Приватный{% endif %}
                    </span>
                    <span>
                        <i class="fas fa-user me-1"></i>
                        {{ playlist.creator.username }}
                    </span>
                    <span>
                        <i class="fas fa-calendar me-1"></i>
                        {{ playlist.created_at|date:"d.m.Y" }}
                    </span>
                </div>
                {% if playlist.description %}
                    <div class="playlist-description">
                        {{ playlist.description }}
                    </div>
                {% endif %}
                <div class="playlist-actions">
                    {% if can_edit %}
                        <a href="{% url 'stories:edit_playlist' playlist.slug %}" class="btn-action">
                            <i class="fas fa-edit me-1"></i>
                            Редактировать
                        </a>
                    {% endif %}
                    <a href="{% url 'stories:playlists_list' %}" class="btn-action">
                        <i class="fas fa-arrow-left me-1"></i>
                        К плейлистам
                    </a>
                    {% if playlist.is_public and not is_public_view %}
                        <a href="{% url 'stories:public_playlist_detail' playlist.creator.id playlist.slug %}" class="btn-action">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Публичная ссылка
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-12">
            {% if playlist_items %}
                {% if can_edit %}
                <div class="playlist-controls">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>
                            Рассказы в плейлисте
                        </h3>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="enableSorting()">
                                <i class="fas fa-sort me-1"></i>
                                Изменить порядок
                            </button>
                            <button class="btn btn-sm btn-success d-none" id="saveSortBtn" onclick="saveSorting()">
                                <i class="fas fa-save me-1"></i>
                                Сохранить
                            </button>
                            <button class="btn btn-sm btn-secondary d-none" id="cancelSortBtn" onclick="cancelSorting()">
                                Отмена
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div id="playlist-items">
                    {% for item in playlist_items %}
                        <div class="story-item" data-story-id="{{ item.story.id }}" data-order="{{ item.order }}">
                            <div class="story-content">
                                {% if can_edit %}
                                <div class="drag-handle d-none">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>
                                {% endif %}
                                <div class="story-thumbnail">
                                    <i class="fas fa-video"></i>
                                </div>
                                <div class="story-info">
                                    <div class="story-title">
                                        <a href="{% url 'stories:detail' item.story.slug %}">
                                            {{ item.story.title }}
                                        </a>
                                    </div>
                                    {% if item.story.description %}
                                        <div class="story-description">
                                            {{ item.story.description|truncatewords:25 }}
                                        </div>
                                    {% endif %}
                                    <div class="story-meta">
                                        {% if item.story.category %}
                                            <span>
                                                <i class="fas fa-folder me-1"></i>
                                                {{ item.story.category.name }}
                                            </span>
                                        {% endif %}
                                        <span>
                                            <i class="fas fa-eye me-1"></i>
                                            {{ item.story.views_count }} просмотр{{ item.story.views_count|pluralize:"ов" }}
                                        </span>
                                        <span>
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ item.story.created_at|date:"d.m.Y" }}
                                        </span>
                                    </div>
                                </div>
                                <div class="story-actions">
                                    <div class="story-order">{{ item.order }}</div>
                                    {% if can_edit %}
                                    <button class="btn-remove" onclick="removeFromPlaylist({{ item.story.id }})">
                                        <i class="fas fa-times me-1"></i>
                                        Удалить
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
            {% else %}
                <div class="empty-playlist">
                    <i class="fas fa-video"></i>
                    <h3>Плейлист пуст</h3>
                    <p>{% if can_edit %}Добавьте рассказы в этот плейлист, чтобы создать свою коллекцию{% else %}В этом плейлисте пока нет рассказов{% endif %}</p>
                    {% if can_edit %}
                    <a href="{% url 'stories:list' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Найти рассказы
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if can_edit %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
let sortable = null;
let originalOrder = [];

document.addEventListener('DOMContentLoaded', function() {
    // Анимация появления элементов
    const items = document.querySelectorAll('.story-item');
    items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

function enableSorting() {
    // Сохраняем оригинальный порядок
    originalOrder = Array.from(document.querySelectorAll('.story-item')).map(item => ({
        id: item.dataset.storyId,
        order: item.dataset.order
    }));
    
    // Показываем элементы управления сортировкой
    document.querySelectorAll('.drag-handle').forEach(handle => {
        handle.classList.remove('d-none');
    });
    
    document.getElementById('saveSortBtn').classList.remove('d-none');
    document.getElementById('cancelSortBtn').classList.remove('d-none');
    
    // Включаем сортировку
    const container = document.getElementById('playlist-items');
    sortable = Sortable.create(container, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag'
    });
}

function saveSorting() {
    const items = document.querySelectorAll('.story-item');
    const storyOrders = Array.from(items).map((item, index) => ({
        story_id: parseInt(item.dataset.storyId),
        order: index + 1
    }));
    
    // Отправляем AJAX запрос для сохранения порядка
    fetch(`{% url 'stories:reorder_playlist' playlist.slug %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            story_orders: storyOrders
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Обновляем номера в интерфейсе
            items.forEach((item, index) => {
                const orderElement = item.querySelector('.story-order');
                orderElement.textContent = index + 1;
                item.dataset.order = index + 1;
            });
            
            cancelSorting();
            showMessage('Порядок рассказов сохранен', 'success');
        } else {
            showMessage('Ошибка при сохранении порядка', 'error');
        }
    })
    .catch(error => {
        showMessage('Произошла ошибка', 'error');
        console.error('Error:', error);
    });
}

function cancelSorting() {
    // Скрываем элементы управления сортировкой
    document.querySelectorAll('.drag-handle').forEach(handle => {
        handle.classList.add('d-none');
    });
    
    document.getElementById('saveSortBtn').classList.add('d-none');
    document.getElementById('cancelSortBtn').classList.add('d-none');
    
    // Отключаем сортировку
    if (sortable) {
        sortable.destroy();
        sortable = null;
    }
}

function removeFromPlaylist(storyId) {
    if (!confirm('Вы уверены, что хотите удалить этот рассказ из плейлиста?')) {
        return;
    }
    
    const url = '/stories/playlists/remove-from-playlist/';
    console.log('Hardcoded URL:', url);
    console.log('Sending request to:', url);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            story_id: storyId,
            playlist_id: {{ playlist.id }}
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Response is not JSON');
        }
        
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Удаляем элемент из DOM с анимацией
            const storyItem = document.querySelector(`[data-story-id="${storyId}"]`);
            storyItem.style.transition = 'all 0.3s ease';
            storyItem.style.transform = 'translateX(-100%)';
            storyItem.style.opacity = '0';
            
            setTimeout(() => {
                storyItem.remove();
                
                // Обновляем номера оставшихся элементов
                const remainingItems = document.querySelectorAll('.story-item');
                remainingItems.forEach((item, index) => {
                    const orderElement = item.querySelector('.story-order');
                    orderElement.textContent = index + 1;
                    item.dataset.order = index + 1;
                });
                
                // Если плейлист стал пустым, показываем соответствующее сообщение
                if (remainingItems.length === 0) {
                    location.reload();
                }
            }, 300);
            
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Произошла ошибка при удалении', 'error');
    });
}

function showMessage(message, type) {
    // Создаем уведомление
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alert.style.position = 'fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.style.minWidth = '300px';
    
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endif %}
{% endblock %}