<!-- –®–∞–±–ª–æ–Ω Dashboard –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ -->
<!-- –°–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ -->

{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã - {{ site_title|default:"Django –ê–¥–º–∏–Ω–∫–∞" }}{% endblock %}

{% block extrahead %}
<meta http-equiv="refresh" content="30">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.monitoring-dashboard {
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    border: 1px solid #e5e7eb;
}

.metric-card h3 {
    margin: 0 0 15px 0;
    color: #374151;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.metric-value {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
}

.metric-value.ok { color: #10b981; }
.metric-value.warning { color: #f59e0b; }
.metric-value.error { color: #ef4444; }

.metric-details {
    font-size: 14px;
    color: #6b7280;
    margin-top: 10px;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-ok { background-color: #10b981; }
.status-warning { background-color: #f59e0b; }
.status-error { background-color: #ef4444; }

.alerts-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
}

.alert-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.alert-warning {
    background-color: #fef3c7;
    border-left-color: #f59e0b;
}

.alert-error {
    background-color: #fee2e2;
    border-left-color: #ef4444;
}

.logs-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
}

.log-viewer {
    background: #1f2937;
    color: #e5e7eb;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 15px;
}

.log-controls {
    margin-bottom: 15px;
}

.log-controls select, .log-controls button {
    margin-right: 10px;
    padding: 6px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background: white;
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.chart-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
}

.chart-container {
    position: relative;
    height: 300px;
}

.refresh-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #3b82f6;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 1000;
}

.loading {
    opacity: 0.7;
    transition: opacity 0.3s;
}

@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
    }
    
    .monitoring-dashboard {
        padding: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <div class="refresh-indicator" id="refreshIndicator">
        <span id="refreshText">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>
    </div>

    <h1>üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</h1>
    <p>–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</p>

    <!-- –ê–ª–µ—Ä—Ç—ã -->
    <div class="alerts-section" id="alertsSection">
        <h2>üö® –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã</h2>
        <div id="alertsList">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤...</p>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="metrics-grid">
        <!-- CPU -->
        <div class="metric-card">
            <h3>
                <span class="status-indicator" id="cpuStatus"></span>
                üíª –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä
            </h3>
            <div class="metric-value" id="cpuValue">--</div>
            <div class="metric-details" id="cpuDetails">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –ü–∞–º—è—Ç—å -->
        <div class="metric-card">
            <h3>
                <span class="status-indicator" id="memoryStatus"></span>
                üß† –ü–∞–º—è—Ç—å
            </h3>
            <div class="metric-value" id="memoryValue">--</div>
            <div class="metric-details" id="memoryDetails">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –î–∏—Å–∫ -->
        <div class="metric-card">
            <h3>
                <span class="status-indicator" id="diskStatus"></span>
                üíæ –î–∏—Å–∫
            </h3>
            <div class="metric-value" id="diskValue">--</div>
            <div class="metric-details" id="diskDetails">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="metric-card">
            <h3>
                <span class="status-indicator" id="dbStatus"></span>
                üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
            </h3>
            <div class="metric-value" id="dbValue">--</div>
            <div class="metric-details" id="dbDetails">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –ö–µ—à -->
        <div class="metric-card">
            <h3>
                <span class="status-indicator" id="cacheStatus"></span>
                üîÑ –ö–µ—à
            </h3>
            <div class="metric-value" id="cacheValue">--</div>
            <div class="metric-details" id="cacheDetails">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
        <div class="metric-card">
            <h3>
                <span class="status-indicator" id="appStatus"></span>
                üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            </h3>
            <div class="metric-value" id="appValue">--</div>
            <div class="metric-details" id="appDetails">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="charts-section">
        <div class="chart-card">
            <h3>üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>
            <div class="chart-container">
                <canvas id="systemChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h3>üåê –ó–∞–ø—Ä–æ—Å—ã –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é</h3>
            <div class="chart-container">
                <canvas id="requestsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- –¢–æ–ø —Å—Ç—Ä–∞–Ω–∏—Ü -->
    <div class="metric-card">
        <h3>üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
        <div id="topPages">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ -->
    <div class="logs-section">
        <h3>üìù –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤</h3>
        <div class="log-controls">
            <select id="logType">
                <option value="general">–û–±—â–∏–µ –ª–æ–≥–∏</option>
                <option value="errors">–û—à–∏–±–∫–∏</option>
                <option value="security">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</option>
                <option value="shop">–ú–∞–≥–∞–∑–∏–Ω</option>
                <option value="auth">–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</option>
            </select>
            <select id="logLines">
                <option value="50">50 —Å—Ç—Ä–æ–∫</option>
                <option value="100">100 —Å—Ç—Ä–æ–∫</option>
                <option value="200">200 —Å—Ç—Ä–æ–∫</option>
            </select>
            <button onclick="loadLogs()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="log-viewer" id="logViewer">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ª–æ–≥–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å"</p>
        </div>
    </div>
</div>

<script>
let systemChart, requestsChart;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
function initCharts() {
    // –ì—Ä–∞—Ñ–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    const systemCtx = document.getElementById('systemChart').getContext('2d');
    systemChart = new Chart(systemCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CPU %',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                },
                {
                    label: '–ü–∞–º—è—Ç—å %',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                },
                {
                    label: '–î–∏—Å–∫ %',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
    const requestsCtx = document.getElementById('requestsChart').getContext('2d');
    requestsChart = new Chart(requestsCtx, {
        type: 'bar',
        data: {
            labels: ['2xx', '3xx', '4xx', '5xx'],
            datasets: [{
                label: '–°—Ç–∞—Ç—É—Å –∫–æ–¥—ã',
                data: [0, 0, 0, 0],
                backgroundColor: [
                    '#10b981',
                    '#3b82f6', 
                    '#f59e0b',
                    '#ef4444'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç—Ä–∏–∫
async function loadMetrics() {
    try {
        document.getElementById('refreshText').textContent = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        
        // –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        const systemResponse = await fetch('/admin/monitoring/api/system/');
        const systemData = await systemResponse.json();
        updateSystemMetrics(systemData);

        // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
        const dbResponse = await fetch('/admin/monitoring/api/database/');
        const dbData = await dbResponse.json();
        updateDatabaseMetrics(dbData);

        // –ö–µ—à
        const cacheResponse = await fetch('/admin/monitoring/api/cache/');
        const cacheData = await cacheResponse.json();
        updateCacheMetrics(cacheData);

        // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        const appResponse = await fetch('/admin/monitoring/api/application/');
        const appData = await appResponse.json();
        updateApplicationMetrics(appData);

        // –ê–ª–µ—Ä—Ç—ã
        const alertsResponse = await fetch('/admin/monitoring/api/alerts/');
        const alertsData = await alertsResponse.json();
        updateAlerts(alertsData);

        document.getElementById('refreshText').textContent = '‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ';
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç—Ä–∏–∫:', error);
        document.getElementById('refreshText').textContent = '‚ùå –û—à–∏–±–∫–∞';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
function updateSystemMetrics(data) {
    if (data.error) {
        console.error('System metrics error:', data.error);
        return;
    }

    // CPU
    const cpuValue = data.cpu.usage;
    document.getElementById('cpuValue').textContent = cpuValue.toFixed(1) + '%';
    document.getElementById('cpuDetails').textContent = `–Ø–¥–µ—Ä: ${data.cpu.count}, –ü—Ä–æ—Ü–µ—Å—Å–æ–≤: ${data.processes}`;
    
    const cpuStatus = document.getElementById('cpuStatus');
    const cpuValueEl = document.getElementById('cpuValue');
    if (cpuValue > 80) {
        cpuStatus.className = 'status-indicator status-error';
        cpuValueEl.className = 'metric-value error';
    } else if (cpuValue > 60) {
        cpuStatus.className = 'status-indicator status-warning';
        cpuValueEl.className = 'metric-value warning';
    } else {
        cpuStatus.className = 'status-indicator status-ok';
        cpuValueEl.className = 'metric-value ok';
    }

    // –ü–∞–º—è—Ç—å
    const memoryValue = data.memory.percent;
    document.getElementById('memoryValue').textContent = memoryValue.toFixed(1) + '%';
    document.getElementById('memoryDetails').textContent = `${data.memory.available}/${data.memory.total} –ì–ë —Å–≤–æ–±–æ–¥–Ω–æ`;
    
    const memoryStatus = document.getElementById('memoryStatus');
    const memoryValueEl = document.getElementById('memoryValue');
    if (memoryValue > 85) {
        memoryStatus.className = 'status-indicator status-error';
        memoryValueEl.className = 'metric-value error';
    } else if (memoryValue > 70) {
        memoryStatus.className = 'status-indicator status-warning';
        memoryValueEl.className = 'metric-value warning';
    } else {
        memoryStatus.className = 'status-indicator status-ok';
        memoryValueEl.className = 'metric-value ok';
    }

    // –î–∏—Å–∫
    const diskValue = data.disk.percent;
    document.getElementById('diskValue').textContent = diskValue.toFixed(1) + '%';
    document.getElementById('diskDetails').textContent = `${data.disk.free}/${data.disk.total} –ì–ë —Å–≤–æ–±–æ–¥–Ω–æ`;
    
    const diskStatus = document.getElementById('diskStatus');
    const diskValueEl = document.getElementById('diskValue');
    if (diskValue > 85) {
        diskStatus.className = 'status-indicator status-error';
        diskValueEl.className = 'metric-value error';
    } else if (diskValue > 75) {
        diskStatus.className = 'status-indicator status-warning';
        diskValueEl.className = 'metric-value warning';
    } else {
        diskStatus.className = 'status-indicator status-ok';
        diskValueEl.className = 'metric-value ok';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
    updateSystemChart(data);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –ë–î
function updateDatabaseMetrics(data) {
    if (data.error) {
        document.getElementById('dbValue').textContent = '–û—à–∏–±–∫–∞';
        document.getElementById('dbDetails').textContent = data.error;
        document.getElementById('dbStatus').className = 'status-indicator status-error';
        document.getElementById('dbValue').className = 'metric-value error';
        return;
    }

    document.getElementById('dbValue').textContent = data.response_time.toFixed(3) + '—Å';
    document.getElementById('dbDetails').textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${data.active_connections}, –†–∞–∑–º–µ—Ä: ${data.database_size_mb} –ú–ë`;
    
    const dbStatus = document.getElementById('dbStatus');
    const dbValueEl = document.getElementById('dbValue');
    if (data.status === 'slow') {
        dbStatus.className = 'status-indicator status-warning';
        dbValueEl.className = 'metric-value warning';
    } else {
        dbStatus.className = 'status-indicator status-ok';
        dbValueEl.className = 'metric-value ok';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∫–µ—à–∞
function updateCacheMetrics(data) {
    if (data.error) {
        document.getElementById('cacheValue').textContent = '–û—à–∏–±–∫–∞';
        document.getElementById('cacheDetails').textContent = data.error;
        document.getElementById('cacheStatus').className = 'status-indicator status-error';
        document.getElementById('cacheValue').className = 'metric-value error';
        return;
    }

    document.getElementById('cacheValue').textContent = data.response_time.toFixed(3) + '—Å';
    
    let details = `–¢–µ—Å—Ç: ${data.test_successful ? '‚úÖ' : '‚ùå'}`;
    if (data.stats.hit_rate !== undefined) {
        details += `, Hit rate: ${data.stats.hit_rate}%`;
    }
    document.getElementById('cacheDetails').textContent = details;
    
    const cacheStatus = document.getElementById('cacheStatus');
    const cacheValueEl = document.getElementById('cacheValue');
    if (data.status === 'slow' || !data.test_successful) {
        cacheStatus.className = 'status-indicator status-warning';
        cacheValueEl.className = 'metric-value warning';
    } else {
        cacheStatus.className = 'status-indicator status-ok';
        cacheValueEl.className = 'metric-value ok';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
function updateApplicationMetrics(data) {
    if (data.error) {
        document.getElementById('appValue').textContent = '–û—à–∏–±–∫–∞';
        document.getElementById('appDetails').textContent = data.error;
        return;
    }

    document.getElementById('appValue').textContent = data.avg_response_time.toFixed(3) + '—Å';
    document.getElementById('appDetails').textContent = `–ó–∞–ø—Ä–æ—Å–æ–≤: ${data.recent_requests_count}, –û—à–∏–±–æ–∫: ${data.error_count}`;
    
    const appStatus = document.getElementById('appStatus');
    const appValueEl = document.getElementById('appValue');
    if (data.error_count > 10 || data.avg_response_time > 2) {
        appStatus.className = 'status-indicator status-warning';
        appValueEl.className = 'metric-value warning';
    } else {
        appStatus.className = 'status-indicator status-ok';
        appValueEl.className = 'metric-value ok';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
    updateRequestsChart(data);

    // –¢–æ–ø —Å—Ç—Ä–∞–Ω–∏—Ü
    updateTopPages(data.top_pages);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤
function updateAlerts(data) {
    const alertsList = document.getElementById('alertsList');
    
    if (!data.alerts || data.alerts.length === 0) {
        alertsList.innerHTML = '<p style="color: #10b981;">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤ –Ω–µ—Ç</p>';
        return;
    }

    let alertsHtml = '';
    data.alerts.forEach(alert => {
        alertsHtml += `
            <div class="alert-item alert-${alert.type}">
                <span>${alert.type === 'error' ? 'üî¥' : '‚ö†Ô∏è'}</span>
                <div style="margin-left: 10px;">
                    <strong>${alert.message}</strong>
                    <br>
                    <small>${new Date(alert.timestamp).toLocaleString()}</small>
                </div>
            </div>
        `;
    });
    
    alertsList.innerHTML = alertsHtml;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
function updateSystemChart(data) {
    const now = new Date().toLocaleTimeString();
    
    if (systemChart.data.labels.length > 20) {
        systemChart.data.labels.shift();
        systemChart.data.datasets.forEach(dataset => {
            dataset.data.shift();
        });
    }
    
    systemChart.data.labels.push(now);
    systemChart.data.datasets[0].data.push(data.cpu.usage);
    systemChart.data.datasets[1].data.push(data.memory.percent);
    systemChart.data.datasets[2].data.push(data.disk.percent);
    
    systemChart.update('none');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
function updateRequestsChart(data) {
    const statusCodes = data.status_codes;
    const counts = [0, 0, 0, 0]; // 2xx, 3xx, 4xx, 5xx
    
    Object.keys(statusCodes).forEach(code => {
        const codeNum = parseInt(code);
        if (codeNum >= 200 && codeNum < 300) counts[0] += statusCodes[code];
        else if (codeNum >= 300 && codeNum < 400) counts[1] += statusCodes[code];
        else if (codeNum >= 400 && codeNum < 500) counts[2] += statusCodes[code];
        else if (codeNum >= 500) counts[3] += statusCodes[code];
    });
    
    requestsChart.data.datasets[0].data = counts;
    requestsChart.update();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ø —Å—Ç—Ä–∞–Ω–∏—Ü
function updateTopPages(pages) {
    const topPagesEl = document.getElementById('topPages');
    
    if (!pages || pages.length === 0) {
        topPagesEl.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
    }

    let html = '<table style="width: 100%; border-collapse: collapse;">';
    html += '<tr style="border-bottom: 1px solid #e5e7eb;"><th style="text-align: left; padding: 8px;">–°—Ç—Ä–∞–Ω–∏—Ü–∞</th><th style="text-align: right; padding: 8px;">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th></tr>';
    
    pages.forEach(page => {
        html += `<tr style="border-bottom: 1px solid #f3f4f6;">
            <td style="padding: 8px; font-family: monospace;">${page.path}</td>
            <td style="padding: 8px; text-align: right;">${page.views}</td>
        </tr>`;
    });
    
    html += '</table>';
    topPagesEl.innerHTML = html;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
async function loadLogs() {
    const logType = document.getElementById('logType').value;
    const logLines = document.getElementById('logLines').value;
    const logViewer = document.getElementById('logViewer');
    
    logViewer.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</p>';
    
    try {
        const response = await fetch(`/admin/monitoring/api/logs/?type=${logType}&lines=${logLines}`);
        const data = await response.json();
        
        if (data.error) {
            logViewer.innerHTML = `<p style="color: #ef4444;">–û—à–∏–±–∫–∞: ${data.error}</p>`;
            return;
        }
        
        if (!data.entries || data.entries.length === 0) {
            logViewer.innerHTML = '<p>–õ–æ–≥–∏ –ø—É—Å—Ç—ã –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            return;
        }
        
        const logsHtml = data.entries.map(entry => {
            let color = '#e5e7eb';
            if (entry.includes('ERROR')) color = '#ef4444';
            else if (entry.includes('WARNING')) color = '#f59e0b';
            else if (entry.includes('INFO')) color = '#3b82f6';
            
            return `<div style="color: ${color}; margin-bottom: 2px;">${escapeHtml(entry)}</div>`;
        }).join('');
        
        logViewer.innerHTML = logsHtml;
        logViewer.scrollTop = logViewer.scrollHeight;
        
    } catch (error) {
        logViewer.innerHTML = `<p style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>`;
    }
}

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadMetrics();
    loadLogs();
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadMetrics, 30000);
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
    setInterval(loadLogs, 60000);
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
setInterval(() => {
    const now = new Date();
    document.getElementById('refreshText').textContent = `‚è∞ ${now.toLocaleTimeString()}`;
}, 1000);
</script>
{% endblock %}