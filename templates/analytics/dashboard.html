{% extends 'base.html' %}
{% load static %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π{% endblock %}

{% block extra_css %}
<style>
.analytics-dashboard {
    padding: 20px;
    background: #f8f9fa;
    min-height: 100vh;
}

.stats-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #2B5AA0;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
    margin-top: 5px;
}

.table-container {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.alert-info {
    border-left: 4px solid #2B5AA0;
    background: #e8f2ff;
}

.content-type-book { color: #28a745; }
.content-type-fairy_tale { color: #ff6b9d; }
.content-type-subscription { color: #ffc107; }
.content-type-audio { color: #6f42c1; }
.content-type-product { color: #007bff; }
</style>
{% endblock %}

{% block content %}
<div class="analytics-dashboard">
    <div class="container-fluid">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="row mb-4">
            <div class="col-12">
                <h1><i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π</h1>
                <p class="text-muted">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∫ –ø–ª–∞—Ç–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É –¥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã</p>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid">
            <div class="stats-card">
                <div class="stat-number">{{ stats.total_intents }}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤ –Ω–∞ "–ö—É–ø–∏—Ç—å"</div>
                <small class="text-success">+{{ stats.intents_today }} —Å–µ–≥–æ–¥–Ω—è</small>
            </div>
            
            <div class="stats-card">
                <div class="stat-number">{{ stats.unique_users }}</div>
                <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                <small class="text-info">–ü–æ–∫–∞–∑—ã–≤–∞–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø–æ–∫—É–ø–∫–µ</small>
            </div>
            
            <div class="stats-card">
                <div class="stat-number">{{ stats.total_subscribers }}</div>
                <div class="stat-label">–ü–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <small class="text-warning">–ì–æ—Ç–æ–≤—ã –∫—É–ø–∏—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ</small>
            </div>
            
            <div class="stats-card">
                <div class="stat-number">{{ stats.intents_week }}</div>
                <div class="stat-label">–ö–ª–∏–∫–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                <small class="text-primary">{{ stats.intents_month }} –∑–∞ –º–µ—Å—è—Ü</small>
            </div>
        </div>

        <div class="row">
            <!-- –¢–æ–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
            <div class="col-lg-6">
                <div class="table-container">
                    <div class="p-3">
                        <h5>üî• –°–∞–º—ã–π –∂–µ–ª–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>–ö–æ–Ω—Ç–µ–Ω—Ç</th>
                                    <th class="text-end">–ö–ª–∏–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for content in top_content|slice:":5" %}
                                <tr>
                                    <td>
                                        <span class="content-type-{{ content.content_type }}">
                                            <i class="fas fa-{% if content.content_type == 'book' %}book{% elif content.content_type == 'fairy_tale' %}magic{% elif content.content_type == 'subscription' %}crown{% elif content.content_type == 'product' %}shopping-bag{% else %}headphones{% endif %}"></i>
                                        </span>
                                        <strong>{{ content.title|truncatechars:40 }}</strong>
                                        <br><small class="text-muted">{{ content.content_type|title }} (ID: {{ content.object_id }})</small>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-danger">{{ content.purchase_intents }} –∫–ª–∏–∫–æ–≤</span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
            <div class="col-lg-6">
                <div class="table-container">
                    <div class="p-3">
                        <h5>üìä –ò–Ω—Ç–µ—Ä–µ—Å –ø–æ —Ç–∏–ø–∞–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>–¢–∏–ø</th>
                                    <th class="text-end">–ö–ª–∏–∫–∏</th>
                                    <th class="text-end">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for content in content_stats %}
                                <tr>
                                    <td>
                                        <span class="content-type-{{ content.content_type }}">
                                            <i class="fas fa-{% if content.content_type == 'book' %}book{% elif content.content_type == 'fairy_tale' %}magic{% elif content.content_type == 'subscription' %}crown{% else %}headphones{% endif %}"></i>
                                            {{ content.content_type|title }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ content.total_clicks }}</strong>
                                    </td>
                                    <td class="text-end">
                                        <small class="text-muted">{{ content.unique_users }}</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º -->
            <div class="col-lg-6">
                <div class="table-container">
                    <div class="p-3">
                        <h5>üéØ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                    <th class="text-end">–ö–ª–∏–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for button in button_stats %}
                                <tr>
                                    <td>
                                        <i class="fas fa-{% if button.button_type == 'buy' %}shopping-cart{% elif button.button_type == 'download' %}download{% elif button.button_type == 'subscribe' %}crown{% else %}play{% endif %}"></i>
                                        {{ button.button_type|title }}
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">{{ button.total_clicks }}</span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- IP –∞–¥—Ä–µ—Å–∞ -->
            <div class="col-lg-6">
                <div class="table-container">
                    <div class="p-3">
                        <h5>üì± IP –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>IP –∞–¥—Ä–µ—Å</th>
                                    <th class="text-end">–ö–ª–∏–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ip in ip_stats %}
                                <tr>
                                    <td>{{ ip.ip_address|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" }}</td>
                                    <td class="text-end">{{ ip.clicks }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì–æ—Ä—è—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        {% if hot_users %}
        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <div class="p-3">
                        <h5>üî• –ì–æ—Ç–æ–≤—ã –ø–ª–∞—Ç–∏—Ç—å (>70% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)</h5>
                    </div>
                    <div class="p-3">
                        {% for user in hot_users|slice:":10" %}
                        <div class="alert alert-warning d-flex justify-content-between align-items-center mb-2">
                            <span>
                                <i class="fas fa-user"></i>
                                {% if user.user %}
                                    {{ user.user.username }}
                                {% else %}
                                    –ê–Ω–æ–Ω_{{ user.session_key|slice:":8" }}
                                {% endif %}
                            </span>
                            <span>
                                <strong>{{ user.purchase_probability|floatformat:0 }}%</strong>
                                <small class="text-muted">
                                    ({{ user.total_purchase_intents }} –∫–ª–∏–∫–æ–≤, {{ user.total_page_views }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)
                                </small>
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- –ò–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5><i class="fas fa-lightbulb"></i> –ò–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h5>
                    <ul class="mb-0">
                        {% if stats.total_intents > 100 %}
                        <li><strong>–í—ã—Å–æ–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å!</strong> –ë–æ–ª–µ–µ 100 –∫–ª–∏–∫–æ–≤ –Ω–∞ –ø–æ–∫—É–ø–∫—É - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É</li>
                        {% endif %}
                        
                        {% if stats.total_subscribers > 50 %}
                        <li><strong>–ì–æ—Ç–æ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:</strong> {{ stats.total_subscribers }} —á–µ–ª–æ–≤–µ–∫ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                        {% endif %}
                        
                        {% for content in top_content|slice:":1" %}
                        <li><strong>–•–∏—Ç –ø—Ä–æ–¥–∞–∂:</strong> {{ content.content_type|title }} #{{ content.object_id }} - {{ content.purchase_intents }} –∫–ª–∏–∫–æ–≤</li>
                        {% endfor %}
                        
                        {% if hot_users.count > 10 %}
                        <li><strong>–ì–æ—Ä—è—á–∏–µ –ª–∏–¥—ã:</strong> {{ hot_users.count }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤—ã—Å–æ–∫–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –ø–æ–∫—É–ø–∫–∏</li>
                        {% endif %}
                        
                        {% if stats.total_intents == 0 %}
                        <li><strong>–ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> –î–æ–±–∞–≤—å—Ç–µ –∑–∞–≥–ª—É—à–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="row">
            <div class="col-12 text-center">
                <button onclick="location.reload()" class="btn btn-primary">
                    <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                </button>
                <a href="/admin/analytics/purchaseintent/" class="btn btn-secondary">
                    <i class="fas fa-cog"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ
                </a>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    fetch('/analytics/api/stats/')
        .then(response => response.json())
        .then(data => {
            console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', data);
        })
        .catch(error => console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error));
}, 30000);
</script>
{% endblock %}