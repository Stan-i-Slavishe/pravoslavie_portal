<!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –ª—é–±–æ–π —à–∞–±–ª–æ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->

<!-- CSRF —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–æ–≤ -->
{% csrf_token %}

<!-- –¢–µ—Å—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
<div class="test-widget">
    <h5>üß™ –¢–µ—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h5>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–æ–≤ -->
    <button onclick="testPurchaseIntent('book', 7, 'buy')" class="btn btn-sm btn-primary mb-1">
        üìö –¢–µ—Å—Ç –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–∏–≥—É
    </button><br>
    
    <button onclick="testPurchaseIntent('fairy_tale', 1, 'buy')" class="btn btn-sm btn-success mb-1">
        üßö‚Äç‚ôÄÔ∏è –¢–µ—Å—Ç –∫–ª–∏–∫–∞ –Ω–∞ —Å–∫–∞–∑–∫—É
    </button><br>
    
    <button onclick="showSubscribePopup('books')" class="btn btn-sm btn-warning mb-1">
        üìß –¢–µ—Å—Ç –ø–æ–¥–ø–∏—Å–∫–∏
    </button><br>
    
    <a href="/analytics/dashboard/" class="btn btn-sm btn-info mb-1" target="_blank">
        üìä –î–∞—à–±–æ—Ä–¥
    </a><br>
    
    <a href="/admin/analytics/" class="btn btn-sm btn-secondary" target="_blank">
        ‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞
    </a>
</div>

<!-- –í–∏–¥–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ -->
{% include 'analytics/widgets/subscribe_button.html' %}

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–æ–≤ –Ω–∞ –ø–æ–∫—É–ø–∫—É
function testPurchaseIntent(contentType, objectId, buttonType) {
    console.log(`–¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫: ${contentType} #${objectId}`);
    
    fetch('/analytics/track-purchase-intent/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
        },
        body: JSON.stringify({
            content_type: contentType,
            object_id: objectId,
            button_type: buttonType,
            session_key: 'test_session_' + Date.now(),
            page_url: window.location.href,
            referer: document.referrer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ –ö–ª–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!\n–í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤: ${data.total_clicks}\n–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏: ${data.user_probability}%`);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error);
    });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>