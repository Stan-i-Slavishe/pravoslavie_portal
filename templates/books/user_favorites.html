{% extends 'base.html' %}
{% load static %}

{% block title %}Мои избранные книги - {{ site_settings.site_name }}{% endblock %}

{% block description %}Ваши избранные книги для удобного доступа{% endblock %}

{% block extra_css %}
<style>
/* Стили для страницы избранного */
.favorites-hero {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    border-radius: 1rem;
    padding: 2.5rem 2rem;
    margin-bottom: 2rem;
    text-align: center;
    color: white;
    position: relative;
    overflow: hidden;
}

.favorites-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
}

.favorites-hero-content {
    position: relative;
    z-index: 2;
}

.favorite-item {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 0.75rem;
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
    position: relative;
}

.favorite-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: #f39c12;
    cursor: pointer;
}

.favorite-cover {
    position: relative;
    aspect-ratio: 3/4;
    background: #f5f5f5;
    overflow: hidden;
}

.favorite-cover a {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
}

.favorite-cover img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #f8f9fa;
    transition: transform 0.3s ease;
}

.favorite-item:hover .favorite-cover img {
    transform: scale(1.02);
}

.favorite-cover a:hover {
    text-decoration: none;
}

.favorite-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #f39c12;
    color: white;
    padding: 4px 8px;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.favorite-content {
    padding: 1.5rem;
    min-height: 200px;
    display: flex;
    flex-direction: column;
}

.favorite-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.favorite-author {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    font-style: italic;
}

.favorite-description {
    color: #555;
    font-size: 0.85rem;
    line-height: 1.4;
    margin-bottom: 0.75rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.favorite-date {
    color: #999;
    font-size: 0.8rem;
    margin-bottom: 1rem;
}

.favorite-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
    margin-top: auto;
}

.favorite-actions .btn {
    min-width: 80px;
    padding: 8px 12px;
    font-size: 0.85rem;
    white-space: nowrap;
    text-align: center;
}

.favorite-actions .btn-primary {
    flex: 1;
    min-width: 90px;
}

.favorite-actions .btn-success {
    min-width: 140px; /* Увеличено для текста "Купить 500 ₽" */
}

.favorite-actions .btn-outline-danger {
    min-width: 40px;
    flex-shrink: 0;
}

.empty-favorites {
    text-align: center;
    padding: 4rem 2rem;
    color: #666;
}

.empty-favorites i {
    font-size: 5rem;
    margin-bottom: 1.5rem;
    opacity: 0.8;
    color: #f39c12;
    text-shadow: 0 2px 10px rgba(243, 156, 18, 0.3);
}

/* Яркие иконки только для этой страницы */
.favorites-hero i {
    color: #fff !important;
    text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    filter: brightness(1.2);
}

.favorite-badge i {
    color: #fff !important;
    filter: brightness(1.3) saturate(1.2);
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.favorite-content i {
    color: #f39c12 !important;
    filter: brightness(1.3) saturate(1.4);
    text-shadow: 0 1px 2px rgba(243, 156, 18, 0.2);
}

.btn i {
    filter: brightness(1.2) saturate(1.3);
}

.bi-bookmark {
    color: #f39c12 !important;
    filter: brightness(1.4) saturate(1.5);
    text-shadow: 0 1px 3px rgba(243, 156, 18, 0.3);
    font-size: 0.35em;
}

.remove-favorite-btn i {
    color: #fff !important;
    filter: brightness(1.2);
    text-shadow: 0 1px 2px rgba(0,0,0,0.4);
}

.remove-favorite-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0.7;
    z-index: 10;
    font-size: 1rem;
}

.favorite-item:hover .remove-favorite-btn {
    opacity: 1;
}

.remove-favorite-btn:hover {
    background: #dc3545;
    transform: scale(1.1);
    opacity: 1 !important;
}

@keyframes pulse {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
}

@media (max-width: 768px) {
    .favorites-hero {
        padding: 2rem 1rem;
    }
    
    .favorite-content {
        padding: 1rem;
    }
    
    .favorite-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .favorite-actions .btn {
        width: 100%;
        min-width: auto;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Героическая секция -->
<div class="favorites-hero">
    <div class="favorites-hero-content">
        <h1>
            <i class="bi bi-bookmark-heart me-2"></i>
            Мои избранные книги
        </h1>
        <p class="lead mb-0">
            Ваша личная коллекция любимых книг
        </p>
    </div>
</div>

<!-- Счетчик и фильтры -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h4 mb-0">
            Избранных книг: {{ favorites.paginator.count }}
        </h2>
        <small class="text-muted">
            {% if favorites.paginator.count %}
                Показано {{ favorites.start_index }}-{{ favorites.end_index }} из {{ favorites.paginator.count }}
            {% endif %}
        </small>
    </div>
    
    {% if favorites.paginator.count > 0 %}
        <div class="d-flex gap-2">
            <a href="{% url 'books:list' %}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-plus-circle me-1"></i>
                Добавить книги
            </a>
        </div>
    {% endif %}
</div>

<!-- Список избранных книг -->
{% if favorites %}
    <div class="row g-4">
        {% for favorite in favorites %}
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="favorite-item">
                    <!-- Кнопка удаления из избранного -->
                    <button class="remove-favorite-btn" 
                            data-book-id="{{ favorite.book.id }}"
                            title="Удалить из избранного">
                        <i class="bi bi-x"></i>
                    </button>
                    
                    <div class="favorite-cover">
                        <a href="{% url 'books:detail' slug=favorite.book.slug %}" 
                           title="{{ favorite.book.title }}">
                            {% if favorite.book.cover %}
                                <img src="{{ favorite.book.cover.url }}" alt="{{ favorite.book.title }}">
                            {% else %}
                                <div class="d-flex align-items-center justify-content-center h-100" 
                                     style="background: linear-gradient(45deg, #f39c12, #e67e22);">
                                    <i class="bi bi-book" style="font-size: 3rem; color: white; opacity: 0.7;"></i>
                                </div>
                            {% endif %}
                        </a>
                        
                        <div class="favorite-badge">
                            <i class="bi bi-bookmark-fill"></i>
                        </div>
                    </div>
                    
                    <div class="favorite-content">
                        <h3 class="favorite-title">
                            <a href="{% url 'books:detail' slug=favorite.book.slug %}" 
                               class="text-decoration-none text-dark">
                                {{ favorite.book.title }}
                            </a>
                        </h3>
                        
                        {% if favorite.book.author %}
                            <div class="favorite-author">{{ favorite.book.author }}</div>
                        {% endif %}
                        
                        {% if favorite.book.description %}
                            <div class="favorite-description">
                                {{ favorite.book.description|truncatewords:15|linebreaksbr }}
                            </div>
                        {% endif %}
                        
                        <div class="favorite-date">
                            <i class="bi bi-calendar-plus me-1"></i>
                            Добавлено: {{ favorite.added_at|date:"d.m.Y" }}
                        </div>
                        
                        <div class="favorite-actions">
                            {% if favorite.book.is_free or user.has_subscription %}
                                <!-- Бесплатная книга или есть подписка -->
                                <a href="{% url 'books:modern_reader' slug=favorite.book.slug %}" 
                                   class="btn btn-primary btn-sm">
                                    <i class="bi bi-tablet-landscape me-1"></i>
                                    Читать
                                </a>
                                
                                <a href="{% url 'books:download' book_id=favorite.book.id %}" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i>
                                </a>
                            {% else %}
                                <!-- Проверяем, купил ли пользователь эту книгу -->
                                {% with favorite.book as book %}
                                    {% if book.id in user_purchased_books %}
                                        <!-- Книга куплена -->
                                        <a href="{% url 'books:modern_reader' slug=book.slug %}" 
                                           class="btn btn-primary btn-sm">
                                            <i class="bi bi-tablet-landscape me-1"></i>
                                            Читать
                                        </a>
                                        
                                        <a href="{% url 'books:download' book_id=book.id %}" 
                                           class="btn btn-success btn-sm">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    {% else %}
                                        <!-- Книга не куплена - показываем кнопку добавления в корзину -->
                                        <button type="button"
                                                class="btn btn-success btn-sm btn-add-to-cart-favorites"
                                                data-book-id="{{ book.id }}"
                                                data-book-price="{{ book.price|floatformat:0 }}"
                                                data-book-title="{{ book.title }}"
                                                style="width: 100%;"
                                                title="Добавить в корзину">
                                            <i class="bi bi-cart-plus me-1"></i>
                                            Купить {{ book.price|floatformat:0 }} ₽
                                        </button>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                            
                            <button class="btn btn-outline-danger btn-sm" 
                                    data-book-id="{{ favorite.book.id }}"
                                    data-action="remove-favorite"
                                    title="Убрать из избранного">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    
{% else %}
    <!-- Пустое состояние -->
    <div class="empty-favorites">
        <i class="bi bi-bookmark-heart"></i>
        <h3>У вас пока нет избранных книг</h3>
        <p class="mb-4">
            Добавляйте интересные книги в избранное, чтобы легко найти их позже.<br>
            Просто нажмите на <i class="bi bi-bookmark text-warning"></i> рядом с любой книгой.
        </p>
        <a href="{% url 'books:list' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-book me-2"></i>
            Найти книги
        </a>
    </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Добавление в корзину с страницы избранного
    document.querySelectorAll('.btn-add-to-cart-favorites').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const bookId = this.dataset.bookId;
            const bookPrice = this.dataset.bookPrice;
            const bookTitle = this.dataset.bookTitle;
            const originalText = this.innerHTML;
            
            // Блокируем кнопку
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass me-1"></i>Добавляем...';
            
            // CSRF токен
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                             document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                             getCookie('csrftoken');
            
            if (!csrfToken) {
                console.error('CSRF token not found');
                this.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Ошибка';
                this.className = 'btn btn-danger btn-sm';
                showNotification('Ошибка безопасности. Перезагрузите страницу.', 'error');
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.className = 'btn btn-success btn-sm btn-add-to-cart-favorites';
                    this.disabled = false;
                }, 3000);
                return;
            }
            
            // Отправляем запрос на добавление в корзину
            fetch('/shop/add-book-to-cart/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'book_id': bookId,
                    'quantity': 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Успешно добавлено
                    this.innerHTML = '<i class="bi bi-check me-1"></i>Добавлено!';
                    this.className = 'btn btn-success btn-sm';
                    
                    // Показываем уведомление
                    showNotification(`Книга "${bookTitle}" добавлена в корзину!`, 'success');
                    
                    // Обновляем счетчик корзины
                    if (window.updateCartCount) {
                        window.updateCartCount();
                    }
                    
                    // Генерируем событие
                    document.dispatchEvent(new CustomEvent('cartUpdated', {
                        detail: {
                            count: data.cart_total_items,
                            total_price: data.cart_total_price
                        }
                    }));
                    
                    // Предлагаем перейти в корзину через 2 секунды
                    setTimeout(() => {
                        this.innerHTML = '<i class="bi bi-cart me-1"></i>Перейти в корзину';
                        this.disabled = false;
                        
                        // Переход в корзину по клику
                        this.onclick = function() {
                            window.location.href = '/shop/cart/';
                        };
                    }, 2000);
                    
                } else {
                    // Ошибка
                    this.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Ошибка';
                    this.className = 'btn btn-danger btn-sm';
                    
                    showNotification(data.message || 'Ошибка добавления в корзину', 'error');
                    
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.className = 'btn btn-success btn-sm btn-add-to-cart-favorites';
                        this.disabled = false;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                this.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Ошибка сети';
                this.className = 'btn btn-danger btn-sm';
                
                showNotification('Ошибка сети. Попробуйте еще раз.', 'error');
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.className = 'btn btn-success btn-sm btn-add-to-cart-favorites';
                    this.disabled = false;
                }, 3000);
            });
        });
    });
    
    // Удаление из избранного (оба способа)
    document.querySelectorAll('.remove-favorite-btn, [data-action="remove-favorite"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const bookId = this.dataset.bookId;
            const favoriteItem = this.closest('.favorite-item');
            
            // Показываем подтверждение
            if (!confirm('Удалить книгу из избранного?')) {
                return;
            }
            
            // AJAX запрос на удаление
            fetch(`/books/favorite/${bookId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Анимация удаления
                    favoriteItem.style.transform = 'scale(0.8)';
                    favoriteItem.style.opacity = '0';
                    
                    setTimeout(() => {
                        favoriteItem.remove();
                        
                        // Проверяем, остались ли книги
                        const remainingItems = document.querySelectorAll('.favorite-item');
                        if (remainingItems.length === 0) {
                            location.reload(); // Обновляем страницу чтобы показать пустое состояние
                        }
                    }, 300);
                    
                    // Показываем уведомление
                    showNotification('Книга удалена из избранного', 'success');
                    
                    // Обновляем счетчик в навигации
                    if (window.updateFavoritesCount) {
                        window.updateFavoritesCount();
                    }
                } else {
                    showNotification('Ошибка при удалении', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Ошибка сети', 'error');
            });
        });
    });
    
    // Функция показа уведомлений
    function showNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 4000);
    }
    
    // Функция получения CSRF токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

<!-- CSRF токен для AJAX запросов -->
{% csrf_token %}
{% endblock %}