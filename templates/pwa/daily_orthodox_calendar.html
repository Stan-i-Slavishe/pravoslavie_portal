{% extends 'base.html' %}
{% load static %}

{% block title %}–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å{% endblock %}

{% block extra_css %}
<style>
:root {
    --no-fast: #28a745;
    --light-fast: #ffc107; 
    --strict-fast: #dc3545;
    --dry-eating: #6f42c1;
    --with-fish: #20c997;
}

.calendar-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
    text-align: center;
}

.today-info {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin: 1rem 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 5px solid var(--primary-color);
}

.fasting-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.fasting-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.fasting-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
}

.fasting-badge.no_fast { background: var(--no-fast); color: white; }
.fasting-badge.light_fast { background: var(--light-fast); color: #000; }
.fasting-badge.strict_fast { background: var(--strict-fast); color: white; }
.fasting-badge.dry_eating { background: var(--dry-eating); color: white; }
.fasting-badge.with_fish { background: var(--with-fish); color: white; }

.food-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    margin: 1rem 0;
    border-left: 4px solid var(--primary-color);
}

.spiritual-note {
    background: linear-gradient(135deg, #ffeaa7, #fab1a0);
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
    font-style: italic;
    position: relative;
}

.spiritual-note::before {
    content: '"';
    font-size: 3rem;
    color: rgba(0,0,0,0.2);
    position: absolute;
    top: -10px;
    left: 10px;
}

.quick-nav {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.quick-nav-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 20px;
    background: #e9ecef;
    color: #495057;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.quick-nav-btn:hover, .quick-nav-btn.active {
    background: var(--primary-color);
    color: white;
}

.loading {
    text-align: center;
    padding: 3rem;
    color: #666;
}

.events-list {
    margin-top: 1rem;
}

.event-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 3px solid var(--primary-color);
}

/* –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –≤–∏–¥–∂–µ—Ç */
.calendar-widget {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    margin: 2rem 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    max-width: 450px;
    margin-left: auto;
    margin-right: auto;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.month-year-selectors {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.month-selector,
.year-selector {
    padding: 0.5rem 0.75rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: white;
    color: var(--primary-color);
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    outline: none;
}

.month-selector:hover,
.year-selector:hover {
    border-color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.month-selector:focus,
.year-selector:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.25);
}

.month-selector {
    min-width: 120px;
}

.year-selector {
    min-width: 80px;
}

.month-nav-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.2rem;
}

.month-nav-btn:hover {
    background: var(--bs-primary-dark);
    transform: scale(1.1);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
}

.weekday-header {
    text-align: center;
    font-weight: 600;
    color: #666;
    font-size: 0.9rem;
    padding: 0.5rem 0;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    position: relative;
    border: 2px solid transparent;
}

.calendar-day:hover {
    background: #f8f9fa;
}

.calendar-day.other-month {
    color: #ccc;
}

.calendar-day.today {
    background: var(--primary-color);
    color: white;
    font-weight: 700;
}

.calendar-day.selected {
    border: 2px solid var(--primary-color);
    background: rgba(var(--bs-primary-rgb), 0.1);
}

.calendar-day.has-event::after {
    content: '';
    position: absolute;
    bottom: 3px;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
}

/* –†–µ–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–Ω–µ–π */
.calendar-day.holiday::after {
    background: #dc3545;
}

/* –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ç–∏–ø—ã –ø–æ—Å—Ç–æ–≤ */
.calendar-day.fast-day::after,
.calendar-day.light-fast::after {
    background: #6f42c1;
}

.calendar-day.feast::after {
    background: #28a745;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–∏–ø–æ–≤ –¥–Ω–µ–π */
.calendar-day.holiday {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    font-weight: 600;
}

/* –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ç–∏–ø—ã –ø–æ—Å—Ç–æ–≤ –ø–æ–¥ –æ–¥–Ω–∏–º —Å—Ç–∏–ª–µ–º */
.calendar-day.fast-day,
.calendar-day.light-fast {
    background: rgba(111, 66, 193, 0.1);
    color: #6f42c1;
    font-weight: 600;
}

/* –û–±—ã—á–Ω—ã–µ –¥–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è */
.calendar-day.feast {
    /* –£–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –¥–Ω–µ–π */
    background: transparent;
    color: inherit;
    font-weight: 500;
}

/* –°–µ–≥–æ–¥–Ω—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ —Ç–∏–ø–∞ –¥–Ω—è */
.calendar-day.today {
    background: var(--primary-color) !important;
    color: white !important;
    font-weight: 700 !important;
}

.calendar-legend {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: #666;
}

.legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.legend-dot.holiday { background: #dc3545; }
.legend-dot.fast-day { background: #6f42c1; }
.legend-dot.feast { background: #28a745; }

@media (max-width: 768px) {
    .calendar-hero {
        padding: 1rem;
        margin: 0.5rem;
        border-radius: 15px;
    }
    
    .today-info {
        padding: 1.5rem;
        margin: 0.5rem;
    }
    
    .quick-nav {
        justify-content: center;
    }
    
    .calendar-widget {
        padding: 1.5rem;
        margin: 1rem 0.5rem;
    }
    
    .calendar-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .month-year-selectors {
        order: -1;
    }
    
    .month-nav-btn {
        width: 35px;
        height: 35px;
        font-size: 1rem;
    }
    
    .month-selector,
    .year-selector {
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
    }
    
    .month-selector {
        min-width: 100px;
    }
    
    .year-selector {
        min-width: 70px;
    }
    
    .calendar-legend {
        font-size: 0.7rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="calendar-hero">
    <h1 class="mb-3">üçΩÔ∏è –ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</h1>
    <p class="lead">–ü–æ—Å—Ç–Ω—ã–µ –¥–Ω–∏, —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–∞—è –ø–∏—â–∞, –¥—É—Ö–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç–∞–≤–ª–µ–Ω–∏—è</p>
</div>

<div class="container">
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
    <div class="today-info">
        <h2>üïäÔ∏è –°–µ–≥–æ–¥–Ω—è, <span id="todayDate">–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</span></h2>
        <div id="todayContent" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–Ω—è...</p>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="quick-nav">
        <button class="quick-nav-btn active" data-days="0">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="quick-nav-btn" data-days="1">–ó–∞–≤—Ç—Ä–∞</button>
        <button class="quick-nav-btn" data-days="7">–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é</button>
        <button class="quick-nav-btn" data-days="-1">–í—á–µ—Ä–∞</button>
        <button class="quick-nav-btn" data-days="-7">–ù–µ–¥–µ–ª—é –Ω–∞–∑–∞–¥</button>
    </div>

    <!-- –ö–ê–õ–ï–ù–î–ê–†–ù–´–ô –í–ò–î–ñ–ï–¢ -->
    <div class="calendar-widget">
        <div class="calendar-header">
            <button class="month-nav-btn" id="prevMonth">‚Äπ</button>
            
            <!-- –ù–æ–≤—ã–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞ -->
            <div class="month-year-selectors">
                <select class="month-selector" id="monthSelector">
                    <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
                    <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
                    <option value="3">–ú–∞—Ä—Ç</option>
                    <option value="4">–ê–ø—Ä–µ–ª—å</option>
                    <option value="5">–ú–∞–π</option>
                    <option value="6">–ò—é–Ω—å</option>
                    <option value="7">–ò—é–ª—å</option>
                    <option value="8">–ê–≤–≥—É—Å—Ç</option>
                    <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
                    <option value="10">–û–∫—Ç—è–±—Ä—å</option>
                    <option value="11">–ù–æ—è–±—Ä—å</option>
                    <option value="12">–î–µ–∫–∞–±—Ä—å</option>
                </select>
                
                <select class="year-selector" id="yearSelector">
                    <!-- –ì–æ–¥—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JavaScript -->
                </select>
            </div>
            
            <button class="month-nav-btn" id="nextMonth">‚Ä∫</button>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
            <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ -->
            <div class="weekday-header">–ü–ù</div>
            <div class="weekday-header">–í–¢</div>
            <div class="weekday-header">–°–†</div>
            <div class="weekday-header">–ß–¢</div>
            <div class="weekday-header">–ü–¢</div>
            <div class="weekday-header">–°–ë</div>
            <div class="weekday-header">–í–°</div>
            
            <!-- –î–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JavaScript -->
        </div>
        
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-dot holiday"></div>
                <span>–ü—Ä–∞–∑–¥–Ω–∏–∫</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot fast-day"></div>
                <span>–ü–æ—Å—Ç</span>
            </div>
        </div>
    </div>

    <!-- –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ -->
    <div id="selectedDateInfo" style="display: none;">
        <h3 id="selectedDateTitle"></h3>
        <div id="selectedDateContent"></div>
    </div>
</div>

<script>
class DailyOrthodoxCalendar {
    constructor() {
        this.currentDate = new Date();
        this.selectedDate = null;
        this.cache = {};
        this.calendarDate = new Date(); // –î–∞—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≤–∏–¥–∂–µ—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        
        this.init();
    }
    
    init() {
        this.loadTodayInfo();
        this.setupEventHandlers();
        this.setupYearSelector();
        this.renderCalendarWidget();
    }
    
    setupYearSelector() {
        const yearSelector = document.getElementById('yearSelector');
        const currentYear = new Date().getFullYear();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ–¥—ã –æ—Ç 1900 –¥–æ 2100
        for (let year = currentYear - 50; year <= currentYear + 50; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) {
                option.selected = true;
            }
            yearSelector.appendChild(option);
        }
    }
    
    async loadTodayInfo() {
        const today = new Date();
        this.showTodayInfo(today);
        await this.loadDateInfo(today);
    }
    
    showTodayInfo(date) {
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        document.getElementById('todayDate').textContent = 
            date.toLocaleDateString('ru-RU', options);
    }
    
    async loadDateInfo(date) {
        const dateKey = this.getDateKey(date);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
        if (this.cache[dateKey]) {
            this.renderDateInfo(date, this.cache[dateKey]);
            return;
        }
        
        try {
            const response = await fetch(
                `/pwa/api/daily-orthodox/${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}/`
            );
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
            
            const data = await response.json();
            this.cache[dateKey] = data;
            
            this.renderDateInfo(date, data);
            
        } catch (error) {
            console.error('Error loading date info:', error);
            this.renderError();
        }
    }
    
    renderDateInfo(date, data) {
        const isToday = this.isToday(date);
        const containerId = isToday ? 'todayContent' : 'selectedDateContent';
        const container = document.getElementById(containerId);
        
        if (!data.daily_info) {
            container.innerHTML = '<p class="text-muted">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>';
            return;
        }
        
        const info = data.daily_info;
        
        let html = `
            <div class="fasting-card">
                <div class="fasting-badge ${info.fasting_type}">
                    ${info.fasting_type_display}
                </div>
                
                ${info.fasting_description ? `
                    <h5>${info.fasting_description}</h5>
                ` : ''}
                
                <div class="food-info">
                    <strong>üçΩÔ∏è –ü–∏—â–∞:</strong>
                    <p class="mb-0 mt-2">${info.allowed_food || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                </div>
                
                ${info.spiritual_note ? `
                    <div class="spiritual-note">
                        ${info.spiritual_note}
                    </div>
                ` : ''}
                
                ${info.gospel_reading ? `
                    <div class="mt-3">
                        <strong>üìñ –ï–≤–∞–Ω–≥–µ–ª—å—Å–∫–æ–µ —á—Ç–µ–Ω–∏–µ:</strong>
                        <p class="mt-2">${info.gospel_reading}</p>
                    </div>
                ` : ''}
                
                ${info.epistle_reading ? `
                    <div class="mt-3">
                        <strong>‚úâÔ∏è –ê–ø–æ—Å—Ç–æ–ª—å—Å–∫–æ–µ —á—Ç–µ–Ω–∏–µ:</strong>
                        <p class="mt-2">${info.epistle_reading}</p>
                    </div>
                ` : ''}
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
        if (data.events && data.events.length > 0) {
            html += '<div class="events-list"><h6>üìÖ –°–æ–±—ã—Ç–∏—è –¥–Ω—è:</h6>';
            data.events.forEach(event => {
                html += `
                    <div class="event-item">
                        <strong>${event.title}</strong>
                        ${event.description ? `<p class="mb-0 mt-1 text-muted">${event.description}</p>` : ''}
                    </div>
                `;
            });
            html += '</div>';
        }
        
        container.innerHTML = html;
        
        if (!isToday) {
            document.getElementById('selectedDateInfo').style.display = 'block';
        }
    }
    
    renderError() {
        const container = document.getElementById('todayContent');
        container.innerHTML = `
            <div class="alert alert-warning">
                <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</strong><br>
                –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
            </div>
        `;
    }
    
    setupEventHandlers() {
        // –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        document.querySelectorAll('.quick-nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const days = parseInt(e.target.dataset.days);
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + days);
                
                this.selectDate(targetDate);
                this.updateActiveNavBtn(e.target);
            });
        });
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º –≤ –≤–∏–¥–∂–µ—Ç–µ
        document.getElementById('prevMonth').addEventListener('click', () => {
            this.calendarDate.setMonth(this.calendarDate.getMonth() - 1);
            this.updateCalendarSelectors();
            this.renderCalendarWidget();
        });
        
        document.getElementById('nextMonth').addEventListener('click', () => {
            this.calendarDate.setMonth(this.calendarDate.getMonth() + 1);
            this.updateCalendarSelectors();
            this.renderCalendarWidget();
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
        document.getElementById('monthSelector').addEventListener('change', (e) => {
            const newMonth = parseInt(e.target.value) - 1; // JS –º–µ—Å—è—Ü—ã —Å 0
            this.calendarDate.setMonth(newMonth);
            this.renderCalendarWidget();
        });
        
        document.getElementById('yearSelector').addEventListener('change', (e) => {
            const newYear = parseInt(e.target.value);
            this.calendarDate.setFullYear(newYear);
            this.renderCalendarWidget();
        });
    }
    
    async renderCalendarWidget() {
        const year = this.calendarDate.getFullYear();
        const month = this.calendarDate.getMonth() + 1; // JS –º–µ—Å—è—Ü—ã —Å 0, API —Å 1
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
        this.updateCalendarSelectors();
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–µ—Å—è—Ü–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            const response = await fetch(`/pwa/api/calendar-month/${year}/${month}/`);
            if (!response.ok) {
                throw new Error('Failed to load calendar data');
            }
            
            const monthData = await response.json();
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–Ω–∏ –º–µ—Å—è—Ü–∞
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const firstDayOfWeek = (firstDay.getDay() + 6) % 7; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0
            
            const grid = document.getElementById('calendarGrid');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–Ω–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏)
            const headers = grid.querySelectorAll('.weekday-header');
            grid.innerHTML = '';
            headers.forEach(header => grid.appendChild(header));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
            for (let i = 0; i < firstDayOfWeek; i++) {
                const prevMonthDay = new Date(year, month - 1, 1 - (firstDayOfWeek - i));
                const dayEl = this.createDayElement(prevMonthDay, true, null);
                grid.appendChild(dayEl);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDay = new Date(year, month - 1, day);
                const dayData = monthData.days[day.toString()];
                const dayEl = this.createDayElement(currentDay, false, dayData);
                grid.appendChild(dayEl);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –¥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏
            const remainingCells = 42 - (firstDayOfWeek + lastDay.getDate()); // 6 –Ω–µ–¥–µ–ª—å * 7 –¥–Ω–µ–π
            for (let day = 1; day <= remainingCells; day++) {
                const nextMonthDay = new Date(year, month, day);
                const dayEl = this.createDayElement(nextMonthDay, true, null);
                grid.appendChild(dayEl);
            }
            
        } catch (error) {
            console.error('Error loading calendar data:', error);
            // Fallback –∫ —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–µ
            this.renderCalendarWidgetFallback();
        }
    }
    
    updateCalendarSelectors() {
        const monthSelector = document.getElementById('monthSelector');
        const yearSelector = document.getElementById('yearSelector');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        monthSelector.value = this.calendarDate.getMonth() + 1; // JS –º–µ—Å—è—Ü—ã —Å 0
        yearSelector.value = this.calendarDate.getFullYear();
    }
    
    createDayElement(date, isOtherMonth, dayData = null) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = date.getDate();
        
        if (isOtherMonth) {
            dayEl.classList.add('other-month');
        }
        
        if (this.isToday(date)) {
            dayEl.classList.add('today');
        }
        
        if (this.selectedDate && this.isSameDay(date, this.selectedDate)) {
            dayEl.classList.add('selected');
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (dayData && !isOtherMonth) {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Ç–∏–ø–∞ –¥–Ω—è
            dayEl.classList.add(dayData.day_type);
            
            // –î–æ–±–∞–≤–ª—è–µ–º tooltip —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            if (dayData.main_event || dayData.fasting_display) {
                const tooltipText = [];
                if (dayData.main_event) {
                    tooltipText.push(`üìÖ ${dayData.main_event}`);
                }
                if (dayData.fasting_display && dayData.fasting_type !== 'no_fast') {
                    tooltipText.push(`üçΩÔ∏è ${dayData.fasting_display}`);
                }
                dayEl.title = tooltipText.join('\n');
            }
        } else if (!isOtherMonth) {
            // Fallback –∫ —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–µ –¥–ª—è –¥–Ω–µ–π –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 3 || dayOfWeek === 5) { // –°—Ä–µ–¥–∞ –∏ –ø—è—Ç–Ω–∏—Ü–∞ - –ø–æ—Å—Ç–Ω—ã–µ –¥–Ω–∏
                dayEl.classList.add('fast-day');
            } else if (dayOfWeek === 0) { // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ - –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å
                dayEl.classList.add('holiday');
            } else {
                dayEl.classList.add('feast');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        dayEl.addEventListener('click', () => {
            this.selectDate(new Date(date));
            this.renderCalendarWidget(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
        });
        
        return dayEl;
    }
    
    renderCalendarWidgetFallback() {
        // –†–µ–∑–µ—Ä–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–æ–π
        const year = this.calendarDate.getFullYear();
        const month = this.calendarDate.getMonth();
        
        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const firstDayOfWeek = (firstDay.getDay() + 6) % 7;
        
        const grid = document.getElementById('calendarGrid');
        const headers = grid.querySelectorAll('.weekday-header');
        grid.innerHTML = '';
        headers.forEach(header => grid.appendChild(header));
        
        for (let i = 0; i < firstDayOfWeek; i++) {
            const prevMonthDay = new Date(year, month, 1 - (firstDayOfWeek - i));
            const dayEl = this.createDayElement(prevMonthDay, true, null);
            grid.appendChild(dayEl);
        }
        
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const currentDay = new Date(year, month, day);
            const dayEl = this.createDayElement(currentDay, false, null);
            grid.appendChild(dayEl);
        }
        
        const remainingCells = 42 - (firstDayOfWeek + lastDay.getDate());
        for (let day = 1; day <= remainingCells; day++) {
            const nextMonthDay = new Date(year, month + 1, day);
            const dayEl = this.createDayElement(nextMonthDay, true, null);
            grid.appendChild(dayEl);
        }
    }
    
    async selectDate(date) {
        this.selectedDate = date;
        
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        
        document.getElementById('selectedDateTitle').textContent = 
            `üìÖ ${date.toLocaleDateString('ru-RU', options)}`;
            
        document.getElementById('selectedDateContent').innerHTML = `
            <div class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...</p>
            </div>
        `;
        
        await this.loadDateInfo(date);
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ
        document.getElementById('selectedDateInfo').scrollIntoView({ 
            behavior: 'smooth' 
        });
    }
    
    updateActiveNavBtn(activeBtn) {
        document.querySelectorAll('.quick-nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
    
    getDateKey(date) {
        return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
    }
    
    isToday(date) {
        const today = new Date();
        return date.toDateString() === today.toDateString();
    }
    
    isSameDay(date1, date2) {
        return date1.toDateString() === date2.toDateString();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    new DailyOrthodoxCalendar();
});
</script>
{% endblock %}