{% extends 'base.html' %}
{% load static %}

{% block title %}–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="text-center mb-4">üîî –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h1>
            
            <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>üì± –°—Ç–∞—Ç—É—Å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    <div id="notification-status" class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å...
                    </div>
                    
                    <button id="request-permission" class="btn btn-primary" style="display: none;">
                        <i class="fas fa-bell"></i> –†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </button>
                    
                    <button id="test-notification" class="btn btn-success" style="display: none;">
                        <i class="fas fa-paper-plane"></i> –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>‚õ™ –ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-warning w-100 mb-2" onclick="sendTestNotification('bedtime')">
                                üåô –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Å–∫–∞–∑–∫–µ
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-info w-100 mb-2" onclick="sendTestNotification('orthodox')">
                                ‚õ™ –ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–π –ø—Ä–∞–∑–¥–Ω–∏–∫
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
            <div class="card">
                <div class="card-header">
                    <h5>üìã –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li><strong>–†–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong> - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ</li>
                        <li><strong>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PWA</strong> - –∫–Ω–æ–ø–∫–∞ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ</li>
                        <li><strong>–ù–∞–∂–º–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏</strong> - —É–≤–∏–¥–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                        <li><strong>–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ</strong> - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
                            <ul>
                                <li>üåô <strong>19:00</strong> - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Å–∫–∞–∑–∫–µ</li>
                                <li>‚õ™ <strong>9:00</strong> - –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏</li>
                                <li>üìö –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// üîî –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
document.addEventListener('DOMContentLoaded', function() {
    checkNotificationStatus();
});

function checkNotificationStatus() {
    const statusDiv = document.getElementById('notification-status');
    const requestBtn = document.getElementById('request-permission');
    const testBtn = document.getElementById('test-notification');
    
    if (!('Notification' in window)) {
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = '<i class="fas fa-times"></i> –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
        return;
    }
    
    const permission = Notification.permission;
    
    switch (permission) {
        case 'granted':
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = '<i class="fas fa-check"></i> Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç!';
            testBtn.style.display = 'inline-block';
            break;
            
        case 'denied':
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = '<i class="fas fa-ban"></i> Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
            break;
            
        case 'default':
            statusDiv.className = 'alert alert-warning';
            statusDiv.innerHTML = '<i class="fas fa-question"></i> –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π';
            requestBtn.style.display = 'inline-block';
            break;
    }
}

// üîî –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
document.getElementById('request-permission').addEventListener('click', async function() {
    try {
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
            console.log('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ');
            checkNotificationStatus();
        } else {
            console.log('‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', error);
    }
});

// üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
document.getElementById('test-notification').addEventListener('click', function() {
    sendTestNotification('test');
});

// üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function sendTestNotification(type) {
    if (!('serviceWorker' in navigator) || !('Notification' in window)) {
        alert('‚ùå Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        return;
    }
    
    if (Notification.permission !== 'granted') {
        alert('‚ùå –†–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
        return;
    }
    
    navigator.serviceWorker.ready.then(function(registration) {
        let title, body, icon, url;
        
        switch (type) {
            case 'bedtime':
                title = '–í—Ä–µ–º—è —Å–∫–∞–∑–∫–∏! üåô';
                body = '–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–±—Ä—É—é —Å–∫–∞–∑–∫—É –¥–ª—è –≤–∞—à–µ–≥–æ –º–∞–ª—ã—à–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º';
                url = '/fairy-tales/';
                break;
                
            case 'orthodox':
                title = '‚õ™ –†–æ–∂–¥–µ—Å—Ç–≤–æ –•—Ä–∏—Å—Ç–æ–≤–æ';
                body = '–í–µ–ª–∏–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫ –†–æ–∂–¥–µ—Å—Ç–≤–∞ –ì–æ—Å–ø–æ–¥–∞ –Ω–∞—à–µ–≥–æ –ò–∏—Å—É—Å–∞ –•—Ä–∏—Å—Ç–∞';
                url = '/stories/';
                break;
                
            case 'test':
            default:
                title = '–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ! üéâ';
                body = '–í–∞—à–∏ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!';
                url = '/';
                break;
        }
        
        registration.showNotification(title, {
            body: body,
            icon: '/static/icons/icon-192x192.png',
            badge: '/static/icons/icon-72x72.png',
            tag: `notification-${type}`,
            requireInteraction: false,
            vibrate: [200, 100, 200],
            actions: [
                {
                    action: 'open',
                    title: '–û—Ç–∫—Ä—ã—Ç—å',
                    icon: '/static/icons/icon-72x72.png'
                },
                {
                    action: 'close',
                    title: '–ó–∞–∫—Ä—ã—Ç—å',
                    icon: '/static/icons/icon-72x72.png'
                }
            ],
            data: {
                url: url,
                type: type,
                timestamp: Date.now()
            }
        });
        
        console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ${title}`);
    }).catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
    });
}
</script>

<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}
