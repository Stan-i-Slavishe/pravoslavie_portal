<!-- –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
<div id="comments-section" class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 id="comments-title">
            <i class="bi bi-chat-dots"></i>
            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ <span id="comments-count">(–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...)</span>
        </h4>
        <div class="comment-sort">
            <select id="comment-sort" class="form-select form-select-sm">
                <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                <option value="oldest">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                <option value="top">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
            </select>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    {% if user.is_authenticated %}
        <div class="comment-form mb-4">
            <div class="d-flex">
                <div class="me-3">
                    <div class="comment-avatar">
                        <i class="bi bi-person-circle" style="font-size: 2rem; color: #666;"></i>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <form id="add-comment-form">
                        {% csrf_token %}
                        <textarea 
                            id="comment-text" 
                            class="form-control" 
                            placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." 
                            rows="3"
                            maxlength="1000"
                            required>
                        </textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">
                                <span id="char-count">0</span>/1000 —Å–∏–º–≤–æ–ª–æ–≤
                            </small>
                            <div>
                                <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="cancelComment()">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-send"></i>
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% else %}
        <div class="comment-auth-prompt mb-4 p-3" style="background: #f8f9fa; border-radius: 8px;">
            <p class="mb-2">
                <i class="bi bi-chat-dots me-2"></i>
                –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            </p>
            <a href="{% url 'account_login' %}" class="btn btn-primary btn-sm">
                <i class="bi bi-box-arrow-in-right me-1"></i>
                –í–æ–π—Ç–∏
            </a>
            <a href="{% url 'account_signup' %}" class="btn btn-outline-primary btn-sm ms-2">
                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </a>
        </div>
    {% endif %}

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div id="comments-loading" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏...</p>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div id="comments-list">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —á–µ—Ä–µ–∑ AJAX -->
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" -->
    <div id="no-comments" class="text-center py-5" style="display: none;">
        <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ddd;"></i>
        <h5 class="text-muted mt-3">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h5>
        <p class="text-muted">–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!</p>
    </div>
</div>

<script>
// –ü—Ä–æ—Å—Ç–æ–π JavaScript –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üé¨ YouTube-style –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    loadComments();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
    document.getElementById('add-comment-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        addComment();
    });
    
    // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
    document.getElementById('comment-text')?.addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('char-count').textContent = count;
    });
});

function loadComments() {
    const storySlug = '{{ story.slug }}';
    
    fetch(`/stories/ajax/${storySlug}/comments/`)
    .then(response => response.json())
    .then(data => {
        document.getElementById('comments-loading').style.display = 'none';
        
        if (data.success) {
            document.getElementById('comments-count').textContent = `(${data.total_comments})`;
            
            if (data.total_comments > 0) {
                document.getElementById('comments-list').innerHTML = data.html || '<p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>';
            } else {
                document.getElementById('no-comments').style.display = 'block';
            }
        } else {
            document.getElementById('comments-list').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        document.getElementById('comments-loading').style.display = 'none';
        document.getElementById('comments-list').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>';
    });
}

function addComment() {
    const text = document.getElementById('comment-text').value.trim();
    if (!text) return;
    
    const storySlug = '{{ story.slug }}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/stories/ajax/${storySlug}/comments/add/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            text: text
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('comment-text').value = '';
            document.getElementById('char-count').textContent = '0';
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            loadComments();
            
            showToast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
        } else {
            showToast(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
    });
}

function cancelComment() {
    document.getElementById('comment-text').value = '';
    document.getElementById('char-count').textContent = '0';
}

function showToast(message, type = 'info') {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ detail_v2.html
    if (window.showToast) {
        window.showToast(message, type);
    } else {
        alert(message);
    }
}
</script>

<style>
.comment-form {
    background: #fff;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e0e0e0;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#comment-text {
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    padding: 10px 15px;
    resize: vertical;
    min-height: 80px;
}

#comment-text:focus {
    border-color: #e74c3c;
    box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
}

.comment-sort select {
    min-width: 150px;
}
</style>
