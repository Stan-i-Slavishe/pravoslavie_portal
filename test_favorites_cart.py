import os
import sys
import django

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –ø—Ä–æ–µ–∫—Ç–∞
sys.path.append(r'E:\pravoslavie_portal')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from books.models import Book
from shop.models import Product

def test_favorites_cart_integration():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∫–æ—Ä–∑–∏–Ω—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º"""
    
    print("üõí –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –ö–û–†–ó–ò–ù–´ –í –ò–ó–ë–†–ê–ù–ù–û–ú")
    print("=" * 60)
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç–Ω—ã–µ –∫–Ω–∏–≥–∏
    paid_books = Book.objects.filter(is_free=False, price__gt=0, is_published=True)
    print(f"üìö –ù–∞–π–¥–µ–Ω–æ –ø–ª–∞—Ç–Ω—ã—Ö –∫–Ω–∏–≥: {paid_books.count()}")
    
    if paid_books.count() == 0:
        print("   ‚ö†Ô∏è  –ù–µ—Ç –ø–ª–∞—Ç–Ω—ã—Ö –∫–Ω–∏–≥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        return
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ
    print("\nüè™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ...")
    books_with_products = 0
    
    for book in paid_books[:5]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 5 –∫–Ω–∏–≥
        products = Product.objects.filter(book_id=book.id, is_active=True)
        has_product = products.exists()
        
        print(f"   üìñ {book.title} ({book.price}‚ÇΩ)")
        print(f"      –¢–æ–≤–∞—Ä –≤ –º–∞–≥–∞–∑–∏–Ω–µ: {'‚úÖ –î–∞' if has_product else '‚ùå –ù–µ—Ç'}")
        
        if has_product:
            books_with_products += 1
        else:
            print("      üîß –°–æ–∑–¥–∞–µ–º —Ç–æ–≤–∞—Ä...")
            product = Product.objects.create(
                product_type='book',
                book_id=book.id,
                title=book.title,
                description=f"–î—É—Ö–æ–≤–Ω–∞—è –∫–Ω–∏–≥–∞ '{book.title}'",
                price=book.price,
                is_active=True,
                is_digital=True,
            )
            print(f"      ‚úÖ –¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω: {product.price}‚ÇΩ")
            books_with_products += 1
    
    print(f"\nüìä –ò—Ç–æ–≥–æ –∫–Ω–∏–≥ —Å —Ç–æ–≤–∞—Ä–∞–º–∏: {books_with_products}")
    
    # 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    print("\nüìã –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:")
    print("1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: python manage.py runserver")
    print("2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ —Å–∏—Å—Ç–µ–º–µ")
    print("3. –î–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–∞—Ç–Ω—ã—Ö –∫–Ω–∏–≥ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ")
    print("4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É: http://127.0.0.1:8000/books/favorites/")
    print("5. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ö—É–ø–∏—Ç—å X ‚ÇΩ' —É –ª—é–±–æ–π –∫–Ω–∏–≥–∏")
    print("6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
    print("   - ‚úÖ –ü–æ—è–≤–∏–ª–æ—Å—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ '–ö–Ω–∏–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É!'")
    print("   - ‚úÖ –û–±–Ω–æ–≤–∏–ª—Å—è —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏")
    print("   - ‚úÖ –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –Ω–∞ '–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É'")
    print("   - ‚úÖ –¢–æ–≤–∞—Ä –ø–æ—è–≤–∏–ª—Å—è –≤ –∫–æ—Ä–∑–∏–Ω–µ")
    
    print("\nüéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:")
    print("–¢–µ–ø–µ—Ä—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –∫–Ω–æ–ø–∫–∞ '–ö—É–ø–∏—Ç—å' –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–∏–≥—É –≤ –∫–æ—Ä–∑–∏–Ω—É,")
    print("–∞ –Ω–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –º–∞–≥–∞–∑–∏–Ω!")
    
    # 4. –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    print("\nüîó –ö–ù–ò–ì–ò –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:")
    test_books = paid_books[:3]
    for book in test_books:
        print(f"   üìñ {book.title} - {book.price}‚ÇΩ")
        print(f"      http://127.0.0.1:8000/books/book/{book.slug}/")
    
    return books_with_products

if __name__ == "__main__":
    print("üöÄ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–†–ó–ò–ù–´ –í –ò–ó–ë–†–ê–ù–ù–û–ú")
    
    try:
        books_count = test_favorites_cart_integration()
        
        print("\nüéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!")
        print("\n–¢–µ–ø–µ—Ä—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º:")
        print("‚úÖ –ö–Ω–æ–ø–∫–∞ '–ö—É–ø–∏—Ç—å' –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–∏–≥—É –ø—Ä—è–º–æ –≤ –∫–æ—Ä–∑–∏–Ω—É")
        print("‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏")
        print("‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã")
        print("‚úÖ –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ '–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É'")
        print("‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–Ω–∏–≥–∏")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        import traceback
        traceback.print_exc()
